<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Java çº¿ç¨‹æ± è¯¦ç»†åˆ†æ"><title>Java çº¿ç¨‹æ± </title>
<link rel=canonical href=https://www.lcsk42.com/post/thread-pool/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Java çº¿ç¨‹æ± "><meta property='og:description' content="Java çº¿ç¨‹æ± è¯¦ç»†åˆ†æ"><meta property='og:url' content='https://www.lcsk42.com/post/thread-pool/'><meta property='og:site_name' content="Lucas's Article"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Java'><meta property='article:tag' content='Thread'><meta property='article:published_time' content='2025-02-12T14:15:39+08:00'><meta property='article:modified_time' content='2025-02-12T14:15:39+08:00'><meta name=twitter:title content="Java çº¿ç¨‹æ± "><meta name=twitter:description content="Java çº¿ç¨‹æ± è¯¦ç»†åˆ†æ"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b46f367e8ae3a2b0.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ« </span></figure><div class=site-meta><h1 class=site-name><a href=/>Lucas's Article</a></h1><h2 class=site-description>Life is short; meeting you is the best fortune.</h2></div></header><ol class=menu-social><li><a href=https://github.com/lcsk42 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:lcsk42@gmail.com target=_blank title=Mail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=https://x.com/lcsk42 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-rss"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/about/><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-pagekit"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12.077 20H7V4h11v14h-5.077"/></svg>
<span>About</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#çº¿ç¨‹æ± åŸºç¡€>çº¿ç¨‹æ± åŸºç¡€</a><ol><li><a href=#çº¿ç¨‹æ± ä¸»è¦å‚æ•°>çº¿ç¨‹æ± ä¸»è¦å‚æ•°</a><ol><li><a href=#corepoolsizeæ ¸å¿ƒçº¿ç¨‹æ•°>(corePoolSize)æ ¸å¿ƒçº¿ç¨‹æ•°</a></li><li><a href=#maximumpoolsizeæœ€å¤§çº¿ç¨‹æ•°>(maximumPoolSize)æœ€å¤§çº¿ç¨‹æ•°</a></li><li><a href=#handleræ‹’ç»ç­–ç•¥>(handler)æ‹’ç»ç­–ç•¥</a></li><li><a href=#çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹>çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹</a></li><li><a href=#ä¸ºä»€ä¹ˆä¸å…è®¸ä½¿ç”¨-executors-å¿«é€Ÿåˆ›å»ºçº¿ç¨‹æ± >ä¸ºä»€ä¹ˆä¸å…è®¸ä½¿ç”¨ Executors å¿«é€Ÿåˆ›å»ºçº¿ç¨‹æ± </a></li></ol></li></ol></li><li><a href=#å¿«æ¶ˆçº¿ç¨‹æ± >å¿«æ¶ˆçº¿ç¨‹æ± </a><ol><li><a href=#taskqueue>TaskQueue</a></li><li><a href=#eagerthreadpoolexecutor>EagerThreadPoolExecutor</a></li></ol></li><li><a href=#æ„å»ºçº¿ç¨‹æ± >æ„å»ºçº¿ç¨‹æ± </a><ol><li><a href=#builder>Builder</a></li><li><a href=#threadfactorybuilder>ThreadFactoryBuilder</a></li><li><a href=#threadpoolbuilder>ThreadPoolBuilder</a></li><li><a href=#ä½¿ç”¨æ–¹å¼>ä½¿ç”¨æ–¹å¼</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/dev/>Dev</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/thread-pool/>Java çº¿ç¨‹æ± </a></h2><h3 class=article-subtitle>Java çº¿ç¨‹æ± è¯¦ç»†åˆ†æ</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 12, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>9 minute read</time></div></footer></div></header><section class=article-content><p>è¯¦ç»†åˆ†æ Java çº¿ç¨‹æ± å‚æ•°ã€å¦‚ä½•æ„å»ºçº¿ç¨‹æ± ï¼Œæ—©æ¶ˆçº¿ç¨‹ã€‚</p><h2 id=çº¿ç¨‹æ± åŸºç¡€>çº¿ç¨‹æ± åŸºç¡€</h2><h3 id=çº¿ç¨‹æ± ä¸»è¦å‚æ•°>çº¿ç¨‹æ± ä¸»è¦å‚æ•°</h3><ul><li><code>corePoolSize(int)[> 0]</code>: æ ¸å¿ƒçº¿ç¨‹æ± æ•°ï¼Œæ± ä¸­ä¿ç•™çš„çº¿ç¨‹æ•°ï¼Œå³ä½¿å®ƒä»¬å¤„äºç©ºé—²çŠ¶æ€ï¼Œé™¤éè®¾ç½®äº† allowCoreThreadTimeOut ä¸º true</li><li><code>maximumPoolSize(int)[> 0]</code>: æœ€å¤§çº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± ä¸­æœ€å¤§å¯åˆ›å»ºçš„çº¿ç¨‹æ•°</li><li><code>keepAliveTime(long)[> 0]</code>: çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼Œå½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€é•¿æ—¶é—´</li><li><code>unit(TimeUnit)</code>: keepAliveTime å‚æ•°çš„æ—¶é—´å•ä½</li><li><code>workQueue(BlockingQueue&lt;Runnable>)[not null]</code>: ç”¨äºåœ¨æ‰§è¡Œä»»åŠ¡ä¹‹å‰ä¿å­˜ä»»åŠ¡çš„é˜Ÿåˆ—</li><li><code>threadFactory(ThreadFactory)[not null]</code>: æ‰§è¡Œå™¨åˆ›å»ºæ–°çº¿ç¨‹æ—¶ä½¿ç”¨çš„å·¥å‚</li><li><code>handler(RejectedExecutionHandler)[not null]</code>: å½“çº¿ç¨‹è¾¹ç•Œå’Œé˜Ÿåˆ—å®¹é‡è¾¾åˆ°ä¸Šé™æ—¶ï¼Œç”¨äºå¤„ç†é˜»å¡æ‰§è¡Œçš„å¤„ç†å™¨</li></ul><h4 id=corepoolsizeæ ¸å¿ƒçº¿ç¨‹æ•°>(corePoolSize)æ ¸å¿ƒçº¿ç¨‹æ•°</h4><p>å¦‚æœæäº¤ä»»åŠ¡åçº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œå½“çº¿ç¨‹æ•°å°äº <code>corePoolSize</code> å€¼æ—¶ï¼Œæ— è®ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦å¿™ç¢Œï¼Œéƒ½ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œå¹¶æŠŠä»»åŠ¡äº¤ç»™æ­¤æ–°åˆ›å»ºçš„çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¦‚æœçº¿ç¨‹æ•°å°‘äºç­‰äº <code>corePoolSize</code>ï¼Œé‚£ä¹ˆè¿™äº›çº¿ç¨‹ä¸ä¼šå›æ”¶ï¼Œé™¤éå°† <code>allowCoreThreadTimeOut</code> è®¾ç½®ä¸º <code>true</code>ï¼Œä½†ä¸€èˆ¬ä¸è¿™ä¹ˆå¹²ï¼Œå› ä¸ºé¢‘ç¹åœ°åˆ›å»ºé”€æ¯çº¿ç¨‹ä¼šæå¤§åœ°å¢åŠ ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ã€‚</p><p>è®¡ç®—æ–¹å¼ï¼š</p><p>é€šè¿‡ Runtime æ–¹æ³•æ¥è·å–å½“å‰æœåŠ¡å™¨ CPU å†…æ ¸æ•°é‡ï¼Œæ ¹æ® CPU å†…æ ¸æ•°é‡æ¥åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ã€‚</p><p>ä¸€èˆ¬æ ¹æ®ä»»åŠ¡ç±»å‹ä¼šæœ‰ä»¥ä¸‹ä¸¤ç§åˆ’åˆ†æ–¹å¼ï¼š</p><ul><li>CPU å¯†é›†å‹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° + 1</li><li>I/O å¯†é›†å‹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>calculateCoreNum</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>cpuCoreNum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>availableProcessors</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BigDecimal</span><span class=p>(</span><span class=n>cpuCoreNum</span><span class=p>).</span><span class=na>divide</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>BigDecimal</span><span class=p>(</span><span class=s>&#34;0.5&#34;</span><span class=p>)).</span><span class=na>intValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=maximumpoolsizeæœ€å¤§çº¿ç¨‹æ•°>(maximumPoolSize)æœ€å¤§çº¿ç¨‹æ•°</h4><p>çº¿ç¨‹æ± ä¸­æœ€å¤§å¯åˆ›å»ºçš„çº¿ç¨‹æ•°ï¼Œå¦‚æœæäº¤ä»»åŠ¡æ—¶é˜Ÿåˆ—æ»¡äº†ä¸”çº¿ç¨‹æ•°æœªåˆ°è¾¾è¿™ä¸ªè®¾å®šå€¼ï¼Œåˆ™ä¼šåˆ›å»ºçº¿ç¨‹å¹¶æ‰§è¡Œæ­¤æ¬¡æäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœæäº¤ä»»åŠ¡æ—¶é˜Ÿåˆ—æ»¡äº†ä½†çº¿æ± æ•°å·²ç»åˆ°è¾¾äº†è¿™ä¸ªå€¼ï¼Œæ­¤æ—¶è¯´æ˜å·²ç»è¶…å‡ºäº†çº¿æ± ç¨‹çš„è´Ÿè½½èƒ½åŠ›ï¼Œå°±ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼Œä¸èƒ½è®©æºæºä¸æ–­åœ°ä»»åŠ¡è¿›æ¥æŠŠçº¿ç¨‹æ± ç»™å‹å®äº†å§ï¼Œé¦–å…ˆè¦ä¿è¯çº¿ç¨‹æ± èƒ½æ­£å¸¸å·¥ä½œã€‚</p><h4 id=handleræ‹’ç»ç­–ç•¥>(handler)æ‹’ç»ç­–ç•¥</h4><p>é»˜è®¤æœ‰ä»¥ä¸‹å››ç§æ‹’ç»ç­–ç•¥ï¼š</p><ol><li><code>AbortPolicy</code>ï¼šä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤ç­–ç•¥</li><li><code>CallerRunsPolicy</code>ï¼šç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœç”¨çš„æ˜¯ CallerRunsPolicy ç­–ç•¥ï¼Œæäº¤ä»»åŠ¡çš„çº¿ç¨‹ï¼ˆæ¯”å¦‚ä¸»çº¿ç¨‹ï¼‰æäº¤ä»»åŠ¡åå¹¶ä¸èƒ½ä¿è¯é©¬ä¸Šå°±è¿”å›ï¼Œå½“è§¦å‘äº†è¿™ä¸ª reject ç­–ç•¥ä¸å¾—ä¸äº²è‡ªæ¥å¤„ç†è¿™ä¸ªä»»åŠ¡</li><li><code>DiscardOldestPolicy</code>ï¼šä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­é æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡</li><li><code>DiscardPolicy</code>ï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼Œè¿™ç§ç­–ç•¥åªé€‚ç”¨äºä¸é‡è¦çš„ä»»åŠ¡</li></ol><p>è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>implements</span><span class=w> </span><span class=n>RejectedExecutionHandler</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>æ³¨æ„ï¼šè‡ªå®šä¹‰é€»è¾‘ä¹‹åï¼Œéœ€è¦æŠ›å‡ºå¼‚å¸¸ã€‚</p></blockquote><h4 id=çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹>çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹</h4><p>å½“ä¸€ä¸ªä»»åŠ¡é€šè¿‡ execute(Runnable) æ–¹æ³•æ¬²æ·»åŠ åˆ°çº¿ç¨‹æ± æ—¶ï¼š</p><ol><li>å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å°äº corePoolSize, å³ä½¿çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹éƒ½å¤„äºç©ºé—²çŠ¶æ€ï¼Œä¹Ÿè¦åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥å¤„ç†è¢«æ·»åŠ çš„ä»»åŠ¡ã€‚</li><li>å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ç­‰äº corePoolSize, ä½†æ˜¯ç¼“å†²é˜Ÿåˆ— workQueue æœªæ»¡ï¼Œåˆ™ä»»åŠ¡è¢«æ”¾å…¥ç¼“å†²é˜Ÿåˆ—ã€‚</li><li>å¦‚æœæ­¤æ—¶çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº corePoolSize, ç¼“å†²é˜Ÿåˆ— workQueue å·²æ»¡ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å°äº maxPoolSize, åˆ™æ–°å»ºçº¿ç¨‹ç”¨æ¥å¤„ç†è¢«æ·»åŠ çš„ä»»åŠ¡ã€‚</li><li>å¦‚æœæ­¤æ—¶çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº corePoolSize, ç¼“å†²é˜Ÿåˆ— workQueue å·²æ»¡ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ç­‰äº maxPoolSize, é‚£ä¹ˆé€šè¿‡ rejectedExecutionHandler æ‰€æŒ‡å®šçš„ç­–ç•¥æ¥å¤„ç†æ­¤ä»»åŠ¡ã€‚</li></ol><p>ä¹Ÿå°±æ˜¯æ•´ä½“ä¼˜å…ˆçº§ä¸ºï¼š æ ¸å¿ƒçº¿ç¨‹ corePoolSize -> ä»»åŠ¡é˜Ÿåˆ— workQueue -> æœ€å¤§çº¿ç¨‹ maxPoolSize -> rejectedExecutionHandler æ‹’ç»ç­–ç•¥</p><h4 id=ä¸ºä»€ä¹ˆä¸å…è®¸ä½¿ç”¨-executors-å¿«é€Ÿåˆ›å»ºçº¿ç¨‹æ± >ä¸ºä»€ä¹ˆä¸å…è®¸ä½¿ç”¨ Executors å¿«é€Ÿåˆ›å»ºçº¿ç¨‹æ± </h4><p>ä½¿ç”¨ Executors å¿«é€Ÿç”Ÿæˆçš„çº¿ç¨‹æ± æ²¡æœ‰å®Œæ•´çš„å‚æ•°é…ç½®ï¼Œ<code>newCachedThreadPool</code> æ–¹æ³•çš„æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®æˆäº† <code>Integer.MAX_VALUE</code>ï¼Œè€Œ <code>newSingleThreadExecutor</code> æ–¹æ³•åˆ›å»º <code>workQueue</code> æ—¶ <code>LinkedBlockingQueue</code> æœªå£°æ˜å¤§å°ï¼Œç›¸å½“äºåˆ›å»ºäº†æ— ç•Œé˜Ÿåˆ—ï¼Œä¸€ä¸å°å¿ƒå°±ä¼šå¯¼è‡´ OOMã€‚</p><h2 id=å¿«æ¶ˆçº¿ç¨‹æ± >å¿«æ¶ˆçº¿ç¨‹æ± </h2><p>æ ¹æ®çº¿ç¨‹æ± çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ ¸å¿ƒçº¿ç¨‹æ»¡äº†ä¹‹åï¼Œæ–°å¢çš„ä»»åŠ¡ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚</p><p>è€Œå¿«æ¶ˆçº¿ç¨‹æ± å°±æ˜¯ï¼Œå‘ç°æ± å†…çº¿ç¨‹å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œè€Œæ˜¯åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹è¿›è¡Œæ¶ˆè´¹ä»»åŠ¡ã€‚</p><h3 id=taskqueue>TaskQueue</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Setter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.LinkedBlockingQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.RejectedExecutionException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å¿«é€Ÿæ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TaskQueue</span><span class=o>&lt;</span><span class=n>R</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Setter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>EagerThreadPoolExecutor</span><span class=w> </span><span class=n>executor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>TaskQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>capacity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>offer</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>runnable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å–çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>currentPoolThreadSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>executor</span><span class=p>.</span><span class=na>getPoolSize</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœæœ‰æ ¸å¿ƒçº¿ç¨‹æ­£åœ¨ç©ºé—²ï¼Œå°†ä»»åŠ¡åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç”±æ ¸å¿ƒçº¿ç¨‹è¿›è¡Œå¤„ç†ä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>executor</span><span class=p>.</span><span class=na>getSubmittedTaskCount</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>currentPoolThreadSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=n>runnable</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å½“å‰çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œè¿”å› Falseï¼Œæ ¹æ®çº¿ç¨‹æ± æºç ï¼Œä¼šåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>currentPoolThreadSize</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>executor</span><span class=p>.</span><span class=na>getMaximumPoolSize</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœå½“å‰çº¿ç¨‹æ± æ•°é‡å¤§äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œä»»åŠ¡åŠ å…¥é˜»å¡é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=n>runnable</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>retryOffer</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>executor</span><span class=p>.</span><span class=na>isShutdown</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RejectedExecutionException</span><span class=p>(</span><span class=s>&#34;Executor is shutdown!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœå½“å‰çº¿ç¨‹æ± æ•°é‡å¤§äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œä»»åŠ¡åŠ å…¥é˜»å¡é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é€šè¿‡è·å–çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ•°é‡è¿›è¡Œå“åº”çš„æ“ä½œã€‚</p><h3 id=eagerthreadpoolexecutor>EagerThreadPoolExecutor</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.BlockingQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.RejectedExecutionException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.RejectedExecutionHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ThreadFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ThreadPoolExecutor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.atomic.AtomicInteger</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å¿«é€Ÿæ¶ˆè´¹çº¿ç¨‹æ± 
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>EagerThreadPoolExecutor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>EagerThreadPoolExecutor</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>corePoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=kt>int</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=kt>long</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>workQueue</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=n>ThreadFactory</span><span class=w> </span><span class=n>threadFactory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=n>RejectedExecutionHandler</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>corePoolSize</span><span class=p>,</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w> </span><span class=n>workQueue</span><span class=p>,</span><span class=w> </span><span class=n>threadFactory</span><span class=p>,</span><span class=w> </span><span class=n>handler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>submittedTaskCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getSubmittedTaskCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>submittedTaskCount</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterExecute</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>submittedTaskCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>command</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>submittedTaskCount</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>command</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RejectedExecutionException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TaskQueue</span><span class=w> </span><span class=n>taskQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>TaskQueue</span><span class=p>)</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>getQueue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>taskQueue</span><span class=p>.</span><span class=na>retryOffer</span><span class=p>(</span><span class=n>command</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>submittedTaskCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RejectedExecutionException</span><span class=p>(</span><span class=s>&#34;Queue capacity is full.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>iex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>submittedTaskCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RejectedExecutionException</span><span class=p>(</span><span class=n>iex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>submittedTaskCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>EagerThreadPoolExecutor</code> ç»§æ‰¿äº† <code>ThreadPoolExecutor</code>ï¼Œåœ¨ <code>execute()</code> ä¸Šåšäº†è‡ªå·±çš„é€»è¾‘å¤„ç†ã€‚</p><p>ç»´æŠ¤äº†ä¸€ä¸ªä»»åŠ¡æ•°é‡çš„å­—æ®µï¼Œæ˜¯ä¸€ä¸ªåŸå­ç±»ï¼Œæ·»åŠ ä»»åŠ¡æ—¶è‡ªå¢ï¼Œä»»åŠ¡å¼‚å¸¸åŠç»“æŸæ—¶é€’å‡ã€‚</p><p>è¿™æ ·å°±èƒ½ä¿è¯ <code>TaskQueue#offer(Runnable runnable)</code> åšå‡ºé€»è¾‘å¤„ç†</p><h2 id=æ„å»ºçº¿ç¨‹æ± >æ„å»ºçº¿ç¨‹æ± </h2><h3 id=builder>Builder</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serializable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Builder æ¨¡å¼æŠ½è±¡æ¥å£
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param &lt;T&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Builder</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ„å»ºæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return æ„å»ºåçš„å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>T</span><span class=w> </span><span class=nf>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=threadfactorybuilder>ThreadFactoryBuilder</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>lombok.AccessLevel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.NoArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.validation.constraints.NotNull</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serial</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Objects</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.Executors</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ThreadFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.atomic.AtomicLong</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * çº¿ç¨‹å·¥å‚æ„å»ºå™¨ï¼Œæä¾›çµæ´»çš„çº¿ç¨‹é…ç½®é€‰é¡¹ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * æ”¯æŒè®¾ç½®çº¿ç¨‹åå‰ç¼€ã€å®ˆæŠ¤çº¿ç¨‹çŠ¶æ€ã€ä¼˜å…ˆçº§å’Œæœªæ•è·å¼‚å¸¸å¤„ç†å™¨ç­‰é…ç½®ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * é‡‡ç”¨å»ºé€ è€…æ¨¡å¼ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ç§æœ‰æ„é€ æ–¹æ³•ï¼Œåªå…è®¸ä½¿ç”¨ builder() æ–¹æ³•åˆ›å»ºå®ä¾‹ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=p>(</span><span class=n>access</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AccessLevel</span><span class=p>.</span><span class=na>PRIVATE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ThreadFactoryBuilder</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Builder</span><span class=o>&lt;</span><span class=n>ThreadFactory</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Serial</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ThreadFactory</span><span class=w> </span><span class=n>backingThreadFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>namePrefix</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=n>daemon</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>priority</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>UncaughtExceptionHandler</span><span class=w> </span><span class=n>uncaughtExceptionHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åˆ›å»ºæ–°çš„ThreadFactoryBuilderå®ä¾‹ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return æ–°çš„ThreadFactoryBuilderå®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ThreadFactoryBuilder</span><span class=w> </span><span class=nf>builder</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadFactoryBuilder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®åº•å±‚çº¿ç¨‹å·¥å‚ã€‚å¦‚æœæœªè®¾ç½®ï¼Œå°†ä½¿ç”¨ Executors.defaultThreadFactory()ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param backingThreadFactory åº•å±‚çº¿ç¨‹å·¥å‚
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws NullPointerException å¦‚æœ backingThreadFactory ä¸º null
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadFactoryBuilder</span><span class=w> </span><span class=nf>threadFactory</span><span class=p>(</span><span class=nd>@NotNull</span><span class=w> </span><span class=n>ThreadFactory</span><span class=w> </span><span class=n>backingThreadFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>backingThreadFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Objects</span><span class=p>.</span><span class=na>requireNonNull</span><span class=p>(</span><span class=n>backingThreadFactory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;backingThreadFactory cannot be null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®çº¿ç¨‹åå‰ç¼€ã€‚å¦‚æœè®¾ç½®ï¼Œçº¿ç¨‹åå°†ä¸º &#34;å‰ç¼€_åºå·&#34; æ ¼å¼ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param namePrefix çº¿ç¨‹åå‰ç¼€
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadFactoryBuilder</span><span class=w> </span><span class=nf>prefix</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>namePrefix</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>namePrefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>namePrefix</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param daemon æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadFactoryBuilder</span><span class=w> </span><span class=nf>daemon</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>daemon</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>daemon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>daemon</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param priority çº¿ç¨‹ä¼˜å…ˆçº§(1-10)
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws IllegalArgumentException å¦‚æœä¼˜å…ˆçº§ä¸åœ¨ Thread.MIN_PRIORITY(1) å’Œ Thread.MAX_PRIORITY(10) ä¹‹é—´
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadFactoryBuilder</span><span class=w> </span><span class=nf>priority</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>priority</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>priority</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>MIN_PRIORITY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;Thread priority (%s) must be &gt;= %s&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>MIN_PRIORITY</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>priority</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>MAX_PRIORITY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;Thread priority (%s) must be &lt;= %s&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>MAX_PRIORITY</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>priority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>priority</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®æœªæ•è·å¼‚å¸¸å¤„ç†å™¨ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param uncaughtExceptionHandler æœªæ•è·å¼‚å¸¸å¤„ç†å™¨
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadFactoryBuilder</span><span class=w> </span><span class=nf>uncaughtExceptionHandler</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>UncaughtExceptionHandler</span><span class=w> </span><span class=n>uncaughtExceptionHandler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>uncaughtExceptionHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uncaughtExceptionHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ„å»ºé…ç½®å¥½çš„ ThreadFactory å®ä¾‹ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return é…ç½®å¥½çš„ ThreadFactory å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadFactory</span><span class=w> </span><span class=nf>build</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>build</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å†…éƒ¨æ„å»ºæ–¹æ³•ï¼Œæ ¹æ®é…ç½®åˆ›å»º ThreadFactoryã€‚
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param builder æ„å»ºå™¨å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     * @return é…ç½®å¥½çš„ ThreadFactory
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ThreadFactory</span><span class=w> </span><span class=nf>build</span><span class=p>(</span><span class=n>ThreadFactoryBuilder</span><span class=w> </span><span class=n>builder</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ThreadFactory</span><span class=w> </span><span class=n>backingThreadFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>backingThreadFactory</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>?</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>backingThreadFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>:</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>defaultThreadFactory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>namePrefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>namePrefix</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=n>daemon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>daemon</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>priority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>priority</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>UncaughtExceptionHandler</span><span class=w> </span><span class=n>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>uncaughtExceptionHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicLong</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>namePrefix</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicLong</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>backingThreadFactory</span><span class=p>.</span><span class=na>newThread</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è®¾ç½®çº¿ç¨‹åç§°(å¦‚æœé…ç½®äº†å‰ç¼€)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>namePrefix</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=n>namePrefix</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;_&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è®¾ç½®å®ˆæŠ¤çº¿ç¨‹çŠ¶æ€(å¦‚æœé…ç½®)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>daemon</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>setDaemon</span><span class=p>(</span><span class=n>daemon</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§(å¦‚æœé…ç½®)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>priority</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>setPriority</span><span class=p>(</span><span class=n>priority</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è®¾ç½®æœªæ•è·å¼‚å¸¸å¤„ç†å™¨(å¦‚æœé…ç½®)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>setUncaughtExceptionHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=threadpoolbuilder>ThreadPoolBuilder</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>lombok.AccessLevel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.NoArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.util.Assert</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.math.BigDecimal</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.BlockingQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.LinkedBlockingQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.RejectedExecutionHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ThreadFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ThreadPoolExecutor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * çº¿ç¨‹æ± æ„å»ºå™¨ï¼Œæä¾›é“¾å¼APIé…ç½®å¹¶åˆ›å»ºThreadPoolExecutorå®ä¾‹ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * è¿™æ˜¯ä¸€ä¸ªä¸å¯å˜æ„å»ºå™¨ï¼Œçº¿ç¨‹å®‰å…¨ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=p>(</span><span class=n>access</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AccessLevel</span><span class=p>.</span><span class=na>PRIVATE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ThreadPoolBuilder</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Builder</span><span class=o>&lt;</span><span class=n>ThreadPoolExecutor</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é»˜è®¤æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºCPUæ ¸å¿ƒæ•°çš„5å€ï¼ˆåŸºäº20%åˆ©ç”¨ç‡è®¡ç®—ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>corePoolSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>calculateCoreNum</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é»˜è®¤æœ€å¤§çº¿ç¨‹æ•°ä¸ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„ 1.5 å€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>corePoolSize</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>corePoolSize</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é»˜è®¤çº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´ 30 ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>keepAliveTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>30_000L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é»˜è®¤æ—¶é—´å•ä½ä¸ºæ¯«ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>timeUnit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é»˜è®¤å·¥ä½œé˜Ÿåˆ—ä¸ºæ— ç•Œé˜Ÿåˆ—ï¼Œå®¹é‡ 4096</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>workQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>4096</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é»˜è®¤æ‹’ç»ç­–ç•¥ä¸º AbortPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RejectedExecutionHandler</span><span class=w> </span><span class=n>rejectedExecutionHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>AbortPolicy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é»˜è®¤çº¿ç¨‹ä¸ºéå®ˆæŠ¤çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isDaemon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// çº¿ç¨‹åå‰ç¼€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>threadNamePrefix</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// çº¿ç¨‹å·¥å‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ThreadFactory</span><span class=w> </span><span class=n>threadFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åˆ›å»º ThreadPoolBuilder å®ä¾‹çš„å·¥å‚æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return æ–°çš„ ThreadPoolBuilder å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=w> </span><span class=nf>builder</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¡ç®—é»˜è®¤æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ŒåŸºäº CPU æ ¸å¿ƒæ•°å’Œ 20% åˆ©ç”¨ç‡
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return è®¡ç®—åçš„æ ¸å¿ƒçº¿ç¨‹æ•°
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>calculateCoreNum</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>cpuCoreNum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>availableProcessors</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BigDecimal</span><span class=p>(</span><span class=n>cpuCoreNum</span><span class=p>).</span><span class=na>divide</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>BigDecimal</span><span class=p>(</span><span class=s>&#34;0.2&#34;</span><span class=p>)).</span><span class=na>intValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param threadFactory çº¿ç¨‹å·¥å‚å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹ï¼ˆé“¾å¼è°ƒç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=w> </span><span class=nf>threadFactory</span><span class=p>(</span><span class=n>ThreadFactory</span><span class=w> </span><span class=n>threadFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>threadFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>threadFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹ï¼ˆé“¾å¼è°ƒç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws IllegalArgumentException å¦‚æœ corePoolSize å°äº0
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=w> </span><span class=nf>corePoolSize</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>corePoolSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>corePoolSize</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Core pool size must be non-negative&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>corePoolSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>corePoolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®æœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦‚æœå°äºå½“å‰æ ¸å¿ƒçº¿ç¨‹æ•°åˆ™è‡ªåŠ¨è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•°
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param maximumPoolSize æœ€å¤§çº¿ç¨‹æ•°
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹ï¼ˆé“¾å¼è°ƒç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws IllegalArgumentException å¦‚æœ maximumPoolSize å°äºç­‰äº 0 æˆ–å°äºæ ¸å¿ƒçº¿ç¨‹æ•°
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=w> </span><span class=nf>maximumPoolSize</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>maximumPoolSize</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Maximum pool size must be positive&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>maximumPoolSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>maximumPoolSize</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>corePoolSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>corePoolSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®çº¿ç¨‹å·¥å‚çš„åŸºæœ¬å±æ€§
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param threadNamePrefix çº¿ç¨‹åå‰ç¼€
</span></span></span><span class=line><span class=cl><span class=cm>     * @param isDaemon         æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹ï¼ˆé“¾å¼è°ƒç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=w> </span><span class=nf>threadFactory</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>threadNamePrefix</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=n>isDaemon</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>threadNamePrefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>threadNamePrefix</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>isDaemon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isDaemon</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®çº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´ï¼ˆä½¿ç”¨é»˜è®¤æ—¶é—´å•ä½æ¯«ç§’ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param keepAliveTime å­˜æ´»æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹ï¼ˆé“¾å¼è°ƒç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=w> </span><span class=nf>keepAliveTime</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>keepAliveTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®çº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´å’Œæ—¶é—´å•ä½
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param keepAliveTime å­˜æ´»æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=cm>     * @param timeUnit      æ—¶é—´å•ä½
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹ï¼ˆé“¾å¼è°ƒç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=w> </span><span class=nf>keepAliveTime</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>timeUnit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>keepAliveTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>timeUnit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®æ‹’ç»ç­–ç•¥
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param rejectedExecutionHandler æ‹’ç»ç­–ç•¥å¤„ç†å™¨
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹ï¼ˆé“¾å¼è°ƒç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=w> </span><span class=nf>rejected</span><span class=p>(</span><span class=n>RejectedExecutionHandler</span><span class=w> </span><span class=n>rejectedExecutionHandler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>rejectedExecutionHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rejectedExecutionHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®å·¥ä½œé˜Ÿåˆ—
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param workQueue å·¥ä½œé˜Ÿåˆ—å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å½“å‰æ„å»ºå™¨å®ä¾‹ï¼ˆé“¾å¼è°ƒç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=w> </span><span class=nf>workQueue</span><span class=p>(</span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>workQueue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>workQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>workQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ„å»ºThreadPoolExecutorå®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return é…ç½®å¥½çš„ThreadPoolExecutorå®ä¾‹
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws IllegalArgumentException å¦‚æœå‚æ•°ä¸åˆæ³•æˆ–çº¿ç¨‹åå‰ç¼€ä¸ºç©º
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=w> </span><span class=nf>build</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>threadFactory</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Assert</span><span class=p>.</span><span class=na>hasLength</span><span class=p>(</span><span class=n>threadNamePrefix</span><span class=p>,</span><span class=w> </span><span class=s>&#34;The thread name prefix cannot be empty or an empty string.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>threadFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadFactoryBuilder</span><span class=p>.</span><span class=na>builder</span><span class=p>().</span><span class=na>prefix</span><span class=p>(</span><span class=n>threadNamePrefix</span><span class=p>).</span><span class=na>daemon</span><span class=p>(</span><span class=n>isDaemon</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadPoolExecutor</span><span class=w> </span><span class=n>executorService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>executorService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>corePoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>timeUnit</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>workQueue</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>threadFactory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>rejectedExecutionHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalArgumentException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Error creating thread pool parameter.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>executorService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ä½¿ç”¨æ–¹å¼>ä½¿ç”¨æ–¹å¼</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Configuration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Primary</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.scheduling.annotation.EnableAsync</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.Executor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// @EnableAsync æ³¨è§£å¯ä»¥æ”¾åœ¨é…ç½®ç±»å’Œå¯åŠ¨ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å¦‚æœç®€å•ä½¿ç”¨ï¼Œä¸ç”¨è‡ªå·±å®šä¹‰çš„çº¿ç¨‹æ± ï¼Œæ”¾åœ¨å¯åŠ¨ç±»ä¹Ÿè¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å¦‚æœä½¿ç”¨äº†è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œæ¨èæ”¾åœ¨é…ç½®ç±»ï¼ŒèŒè´£åˆ†ç¦»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableAsync</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ThreadPoolConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ± é…ç½®ï¼Œéœ€è¦é…ç½®ä¸€ä¸ªé»˜è®¤çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Primary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœæƒ³è¦ @Async æ³¨è§£ä½¿ç”¨å½“å‰çº¿ç¨‹æ± ï¼Œéœ€è¦æ³¨æ„ï¼Œåç§°å¿…é¡»æ˜¯ &#34;taskExecutor&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Executor</span><span class=w> </span><span class=nf>taskExecutor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æœ€ç®€å•çš„åˆ›å»ºæ–¹å¼ï¼ŒæŒ‡å®šçº¿ç¨‹å‰ç¼€å³å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ThreadPoolBuilder</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>threadFactory</span><span class=p>(</span><span class=s>&#34;d_task_&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/thread/>Thread</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/completable-future/><div class=article-details><h2 class=article-title>CompletableFuture</h2></div></a></article><article><a href=/post/spring-boot/><div class=article-details><h2 class=article-title>Spring Boot</h2></div></a></article><article><a href=/post/distributed-lock/><div class=article-details><h2 class=article-title>åˆ†å¸ƒå¼é”</h2></div></a></article><article><a href=/post/java-microbenchmark-harness/><div class=article-details><h2 class=article-title>Java Microbenchmark Harness</h2></div></a></article><article><a href=/post/rabbitmq/><div class=article-details><h2 class=article-title>RabbitMQ</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Lucas's Article</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>