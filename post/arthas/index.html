<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="整理 Arthas 的使用方法"><title>Arthas</title>
<link rel=canonical href=https://www.lcsk42.com/post/arthas/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Arthas"><meta property='og:description' content="整理 Arthas 的使用方法"><meta property='og:url' content='https://www.lcsk42.com/post/arthas/'><meta property='og:site_name' content="Lucas's Article"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Arthas'><meta property='article:published_time' content='2024-03-22T09:39:46+08:00'><meta property='article:modified_time' content='2024-03-22T09:39:46+08:00'><meta name=twitter:title content="Arthas"><meta name=twitter:description content="整理 Arthas 的使用方法"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b46f367e8ae3a2b0.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🫠</span></figure><div class=site-meta><h1 class=site-name><a href=/>Lucas's Article</a></h1><h2 class=site-description>Life is short; meeting you is the best fortune.</h2></div></header><ol class=menu-social><li><a href=https://github.com/lcsk42 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:lcsk42@gmail.com target=_blank title=Mail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=https://x.com/lcsk42 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-rss"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/about/><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-pagekit"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12.077 20H7V4h11v14h-5.077"/></svg>
<span>About</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#开始>开始</a></li><li><a href=#表达式核心变量>表达式核心变量</a></li><li><a href=#基础命令>基础命令</a><ol><li><a href=#help>help</a></li><li><a href=#cls>cls</a></li><li><a href=#session>session</a></li><li><a href=#reset>reset</a></li><li><a href=#version>version</a></li><li><a href=#history>history</a></li><li><a href=#quit-stop>quit-stop</a></li><li><a href=#keymap>keymap</a><ol><li><a href=#自定义快捷键>自定义快捷键</a></li><li><a href=#后台异步命令相关快捷键>后台异步命令相关快捷键</a></li></ol></li><li><a href=#cat>cat</a></li><li><a href=#echo>echo</a></li><li><a href=#grep>grep</a></li><li><a href=#tee>tee</a></li><li><a href=#pwd>pwd</a></li><li><a href=#plaintext>plaintext</a></li><li><a href=#wc>wc</a></li><li><a href=#options>options</a><ol><li><a href=#打开-unsafe-开关支持-jdk-package-下的类>打开 unsafe 开关，支持 jdk package 下的类</a></li><li><a href=#关闭-strict-模式允许在-ognl-表达式里设置对象属性>关闭 strict 模式，允许在 ognl 表达式里设置对象属性</a></li></ol></li></ol></li><li><a href=#系统命令>系统命令</a><ol><li><a href=#dashboard>dashboard</a><ol><li><a href=#数据说明>数据说明</a></li><li><a href=#jvm-内部线程>JVM 内部线程</a></li></ol></li><li><a href=#thread>thread</a></li><li><a href=#jvm>jvm</a></li><li><a href=#sysprop>sysprop</a></li><li><a href=#sysenv>sysenv</a></li><li><a href=#vmoption>vmoption</a></li><li><a href=#vmtool>vmtool</a></li><li><a href=#perfcounter>perfcounter</a></li><li><a href=#logger>logger</a></li><li><a href=#getstatic>getstatic</a></li><li><a href=#ognl>ognl</a></li><li><a href=#mbean>mbean</a></li><li><a href=#heapdump>heapdump</a></li></ol></li><li><a href=#类命令>类命令</a><ol><li><a href=#sc>sc</a></li><li><a href=#sm>sm</a></li><li><a href=#jad>jad</a></li><li><a href=#mc-retransform>mc-retransform</a><ol><li><a href=#如果对某个类执行-retransform-之后想消除影响则需要>如果对某个类执行 retransform 之后，想消除影响，则需要</a></li><li><a href=#结合-jadmc-命令使用>结合 jad/mc 命令使用</a></li><li><a href=#上传-class-文件到服务器的技巧>上传 .class 文件到服务器的技巧</a></li></ol></li><li><a href=#mc-redefine>mc-redefine</a></li><li><a href=#dump>dump</a></li><li><a href=#classloader>classloader</a></li></ol></li><li><a href=#增强命令>增强命令</a><ol><li><a href=#monitor>monitor</a><ol><li><a href=#指定-class-最大匹配数量>指定 Class 最大匹配数量</a></li><li><a href=#计算条件表达式过滤统计结果方法执行完毕之后>计算条件表达式过滤统计结果(方法执行完毕之后)</a></li><li><a href=#计算条件表达式过滤统计结果方法执行完毕之前>计算条件表达式过滤统计结果(方法执行完毕之前)</a></li></ol></li><li><a href=#watch>watch</a><ol><li><a href=#观察函数调用返回时的参数this-对象和返回值>观察函数调用返回时的参数、this 对象和返回值</a></li><li><a href=#指定-class-最大匹配数量-1>指定 Class 最大匹配数量</a></li><li><a href=#观察函数调用入口的参数和返回值>观察函数调用入口的参数和返回值</a></li><li><a href=#同时观察函数调用前和函数返回后>同时观察函数调用前和函数返回后</a></li><li><a href=#调整-x-的值观察具体的函数参数值>调整-x 的值，观察具体的函数参数值</a></li><li><a href=#条件表达式的例子>条件表达式的例子</a></li><li><a href=#观察异常信息的例子>观察异常信息的例子</a></li><li><a href=#按照耗时进行过滤>按照耗时进行过滤</a></li><li><a href=#观察当前对象中的属性>观察当前对象中的属性</a></li><li><a href=#获取类的静态字段调用类的静态函数的例子>获取类的静态字段、调用类的静态函数的例子</a></li><li><a href=#排除掉指定的类>排除掉指定的类</a></li><li><a href=#不匹配子类>不匹配子类</a></li><li><a href=#使用--v-参数打印更多信息>使用 -v 参数打印更多信息</a></li></ol></li><li><a href=#trace>trace</a><ol><li><a href=#trace-函数>trace 函数</a></li><li><a href=#指定-class-匹配的最大数量>指定 Class 匹配的最大数量</a></li><li><a href=#trace-次数限制>trace 次数限制</a></li><li><a href=#包含-jdk-的函数>包含 jdk 的函数</a></li><li><a href=#根据调用耗时过滤>根据调用耗时过滤</a></li><li><a href=#trace-多个类或者多个函数>trace 多个类或者多个函数</a></li><li><a href=#trace-时间不准确>trace 时间不准确</a></li></ol></li><li><a href=#stack>stack</a><ol><li><a href=#stack---run>stack - run</a></li><li><a href=#指定-class-最大匹配数量-2>指定 Class 最大匹配数量</a></li><li><a href=#据条件表达式来过滤>据条件表达式来过滤</a></li><li><a href=#据执行时间来过滤>据执行时间来过滤</a></li></ol></li><li><a href=#tt>tt</a><ol><li><a href=#记录调用>记录调用</a></li><li><a href=#指定-class-最大匹配数量-3>指定 Class 最大匹配数量</a></li><li><a href=#检索调用记录>检索调用记录</a></li><li><a href=#查看调用信息>查看调用信息</a></li><li><a href=#重做一次调用>重做一次调用</a></li><li><a href=#观察表达式>观察表达式</a></li><li><a href=#通过索引删除指定的-tt-记录>通过索引删除指定的 tt 记录</a></li><li><a href=#清除所有的-tt-记录>清除所有的 tt 记录</a></li></ol></li><li><a href=#profiler>profiler</a><ol><li><a href=#启动-profiler>启动 profiler</a></li><li><a href=#获取已采集的-sample-的数量>获取已采集的 sample 的数量</a></li><li><a href=#查看-profiler-状态>查看 profiler 状态</a></li><li><a href=#停止-profiler>停止 profiler</a></li><li><a href=#profiler-支持的-events>profiler 支持的 events</a></li><li><a href=#恢复采样>恢复采样</a></li><li><a href=#使用-execute-来执行复杂的命令>使用 execute 来执行复杂的命令</a></li><li><a href=#查看所有支持的-action>查看所有支持的 action</a></li><li><a href=#查看版本>查看版本</a></li><li><a href=#配置-framebuf-参数>配置 framebuf 参数</a></li><li><a href=#配置-includeexclude-来过滤数据>配置 include/exclude 来过滤数据</a></li><li><a href=#指定执行时间>指定执行时间</a></li><li><a href=#生成-jfr-格式结果>生成 jfr 格式结果</a></li></ol></li><li><a href=#jfr>jfr</a><ol><li><a href=#启动-jfr-记录>启动 JFR 记录</a></li><li><a href=#查看-jfr-记录状态>查看 JFR 记录状态</a></li><li><a href=#dump-jfr-记录>dump jfr 记录</a></li><li><a href=#停止-jfr-记录>停止 jfr 记录</a></li><li><a href=#通过浏览器查看-arthas-output-下面-jfr-记录的结果>通过浏览器查看 arthas-output 下面 JFR 记录的结果</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/ops/>Ops</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/arthas/>Arthas</a></h2><h3 class=article-subtitle>整理 Arthas 的使用方法</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 22, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>38 minute read</time></div></footer></div></header><section class=article-content><p>Alibaba 开源的 Java 诊断工具 Arthas 使用记录。</p><h2 id=开始>开始</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>## 下载启动测试程序</span>
</span></span><span class=line><span class=cl>curl -O https://arthas.aliyun.com/math-game.jar
</span></span><span class=line><span class=cl>java -jar math-game.jar
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 下载启动 arthas</span>
</span></span><span class=line><span class=cl>curl -O https://arthas.aliyun.com/arthas-boot.jar
</span></span><span class=line><span class=cl>java -jar arthas-boot.jar
</span></span></code></pre></td></tr></table></div></div><h2 id=表达式核心变量>表达式核心变量</h2><p>无论是匹配表达式也好、观察表达式也罢，他们核心判断变量都是围绕着一个 Arthas 中的通用通知对象 <code>Advice</code> 进行。</p><p>它的简略代码结构如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Advice</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>loader</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>clazz</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ArthasMethod</span><span class=w> </span><span class=n>method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>returnObj</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>throwExp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isBefore</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isThrow</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isReturn</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// getter/setter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里列一个表格来说明不同变量的含义</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>变量名</th><th>变量解释</th></tr></thead><tbody><tr><td style=text-align:right>loader</td><td>本次调用类所在的 ClassLoader</td></tr><tr><td style=text-align:right>clazz</td><td>本次调用类的 Class 引用</td></tr><tr><td style=text-align:right>method</td><td>本次调用方法反射引用</td></tr><tr><td style=text-align:right>target</td><td>本次调用类的实例</td></tr><tr><td style=text-align:right>params</td><td>本次调用参数列表，这是一个数组，如果方法是无参方法则为空数组</td></tr><tr><td style=text-align:right>returnObj</td><td>本次调用返回的对象。当且仅当 isReturn==true 成立时候有效，表明方法调用是以正常返回的方式结束。如果当前方法无返回值 void，则值为 null</td></tr><tr><td style=text-align:right>throwExp</td><td>本次调用抛出的异常。当且仅当 isThrow==true 成立时有效，表明方法调用是以抛出异常的方式结束。</td></tr><tr><td style=text-align:right>isBefore</td><td>辅助判断标记，当前的通知节点有可能是在方法一开始就通知，此时 isBefore==true 成立，同时 isThrow==false 和 isReturn==false，因为在方法刚开始时，还无法确定方法调用将会如何结束。</td></tr><tr><td style=text-align:right>isThrow</td><td>辅助判断标记，当前的方法调用以抛异常的形式结束。</td></tr><tr><td style=text-align:right>isReturn</td><td>辅助判断标记，当前的方法调用以正常返回的形式结束。</td></tr></tbody></table></div><p>所有变量都可以在表达式中直接使用，如果在表达式中编写了不符合 OGNL 脚本语法或者引入了不在表格中的变量，则退出命令的执行；用户可以根据当前的异常信息修正 <code>条件表达式 </code>或 <code>观察表达式</code>。</p><h2 id=基础命令>基础命令</h2><h3 id=help>help</h3><p>查看命令帮助信息，可以查看当前 arthas 版本支持的指令，或者查看具体指令的使用说明。</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right>不接参数</td><td>查询当前 arthas 版本支持的指令以及指令描述</td></tr><tr><td style=text-align:right>[name:]</td><td>查询具体指令的使用说明</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>help</span>
</span></span><span class=line><span class=cl> NAME         DESCRIPTION
</span></span><span class=line><span class=cl> <span class=nb>help</span>         Display Arthas Help
</span></span><span class=line><span class=cl> auth         Authenticates the current session
</span></span><span class=line><span class=cl> keymap       Display all the available keymap <span class=k>for</span> the specified connection.
</span></span><span class=line><span class=cl> sc           Search all the classes loaded by JVM
</span></span><span class=line><span class=cl> sm           Search the method of classes loaded by JVM
</span></span><span class=line><span class=cl> classloader  Show classloader info
</span></span><span class=line><span class=cl> jad          Decompile class
</span></span><span class=line><span class=cl> getstatic    Show the static field of a class
</span></span><span class=line><span class=cl> monitor      Monitor method execution statistics, e.g. total/success/failure count, average rt, fail rate, etc.
</span></span><span class=line><span class=cl> stack        Display the stack trace <span class=k>for</span> the specified class and method
</span></span><span class=line><span class=cl> thread       Display thread info, thread stack
</span></span><span class=line><span class=cl> trace        Trace the execution <span class=nb>time</span> of specified method invocation.
</span></span><span class=line><span class=cl> watch        Display the input/output parameter, <span class=k>return</span> object, and thrown exception of specified method invocation
</span></span><span class=line><span class=cl> tt           Time Tunnel
</span></span><span class=line><span class=cl> jvm          Display the target JVM information
</span></span><span class=line><span class=cl> memory       Display jvm memory info.
</span></span><span class=line><span class=cl> perfcounter  Display the perf counter information.
</span></span><span class=line><span class=cl> ognl         Execute ognl expression.
</span></span><span class=line><span class=cl> mc           Memory compiler, compiles java files into bytecode and class files in memory.
</span></span><span class=line><span class=cl> redefine     Redefine classes. @see Instrumentation#redefineClasses<span class=o>(</span>ClassDefinition...<span class=o>)</span>
</span></span><span class=line><span class=cl> retransform  Retransform classes. @see Instrumentation#retransformClasses<span class=o>(</span>Class...<span class=o>)</span>
</span></span><span class=line><span class=cl> dashboard    Overview of target jvm<span class=err>&#39;</span>s thread, memory, gc, vm, tomcat info.
</span></span><span class=line><span class=cl> dump         Dump class byte array from JVM
</span></span><span class=line><span class=cl> heapdump     Heap dump
</span></span><span class=line><span class=cl> options      View and change various Arthas options
</span></span><span class=line><span class=cl> cls          Clear the screen
</span></span><span class=line><span class=cl> reset        Reset all the enhanced classes
</span></span><span class=line><span class=cl> version      Display Arthas version
</span></span><span class=line><span class=cl> session      Display current session information
</span></span><span class=line><span class=cl> sysprop      Display and change the system properties.
</span></span><span class=line><span class=cl> sysenv       Display the system env.
</span></span><span class=line><span class=cl> vmoption     Display, and update the vm diagnostic options.
</span></span><span class=line><span class=cl> logger       Print logger info, and update the logger level
</span></span><span class=line><span class=cl> <span class=nb>history</span>      Display <span class=nb>command</span> <span class=nb>history</span>
</span></span><span class=line><span class=cl> cat          Concatenate and print files
</span></span><span class=line><span class=cl> base64       Encode and decode using Base64 representation
</span></span><span class=line><span class=cl> <span class=nb>echo</span>         write arguments to the standard output
</span></span><span class=line><span class=cl> <span class=nb>pwd</span>          Return working directory name
</span></span><span class=line><span class=cl> mbean        Display the mbean information
</span></span><span class=line><span class=cl> grep         grep <span class=nb>command</span> <span class=k>for</span> pipes.
</span></span><span class=line><span class=cl> tee          tee <span class=nb>command</span> <span class=k>for</span> pipes.
</span></span><span class=line><span class=cl> profiler     Async Profiler. https://github.com/jvm-profiling-tools/async-profiler
</span></span><span class=line><span class=cl> vmtool       jvm tool
</span></span><span class=line><span class=cl> stop         Stop/Shutdown Arthas server and <span class=nb>exit</span> the console.
</span></span><span class=line><span class=cl> jfr          Java Flight Recorder Command
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>help</span> dashboard
</span></span><span class=line><span class=cl> USAGE:
</span></span><span class=line><span class=cl>   dashboard <span class=o>[</span>-h<span class=o>]</span> <span class=o>[</span>-i &lt;value&gt;<span class=o>]</span> <span class=o>[</span>-n &lt;value&gt;<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> SUMMARY:
</span></span><span class=line><span class=cl>   Overview of target jvm<span class=err>&#39;</span>s thread, memory, gc, vm, tomcat info.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> EXAMPLES:
</span></span><span class=line><span class=cl>   dashboard
</span></span><span class=line><span class=cl>   dashboard -n <span class=m>10</span>
</span></span><span class=line><span class=cl>   dashboard -i <span class=m>2000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> WIKI:
</span></span><span class=line><span class=cl>   https://arthas.aliyun.com/doc/dashboard
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> OPTIONS:
</span></span><span class=line><span class=cl> -h, --help                              this <span class=nb>help</span>
</span></span><span class=line><span class=cl> -i, --interval &lt;value&gt;                  The interval <span class=o>(</span>in ms<span class=o>)</span> between two executions, default is <span class=m>5000</span> ms.
</span></span><span class=line><span class=cl> -n, --number-of-execution &lt;value&gt;       The number of <span class=nb>times</span> this <span class=nb>command</span> will be executed.
</span></span></code></pre></td></tr></table></div></div><h3 id=cls>cls</h3><p>清空当前屏幕区域。</p><h3 id=session>session</h3><p>查看当前会话的信息，显示当前绑定的 pid 以及会话 id。</p><blockquote><p><strong>提示</strong></p><p>如果配置了 tunnel server，会追加打印 代理 id、tunnel 服务器的 url 以及连接状态。</p><p>如果使用了 staturl 做统计，会追加显示 statUrl 地址。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ session
</span></span><span class=line><span class=cl> Name        Value
</span></span><span class=line><span class=cl>--------------------------------------------------
</span></span><span class=line><span class=cl> JAVA_PID    <span class=m>96956</span>
</span></span><span class=line><span class=cl> SESSION_ID  14219aff-0255-4e7d-aaa8-244061bd8277
</span></span></code></pre></td></tr></table></div></div><h3 id=reset>reset</h3><blockquote><p><strong>提示</strong></p><p>重置增强类，将被 Arthas 增强过的类全部还原，Arthas 服务端 stop 时会重置所有增强过的类</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 还原指定类</span>
</span></span><span class=line><span class=cl>reset Test
</span></span><span class=line><span class=cl><span class=c1># 还原所有类</span>
</span></span><span class=line><span class=cl>reset
</span></span></code></pre></td></tr></table></div></div><h3 id=version>version</h3><p>输出当前目标 Java 进程所加载的 Arthas 版本号</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ version
</span></span><span class=line><span class=cl>3.7.2
</span></span></code></pre></td></tr></table></div></div><h3 id=history>history</h3><p>打印命令历史。</p><blockquote><p><strong>提示</strong></p><p>历史指令会通过一个名叫 history 的文件持久化，所以 history 指令可以查看当前 arthas 服务器的所有历史命令，而不仅只是当前次会话使用过的命令。</p></blockquote><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right>[c:]</td><td>清空历史指令</td></tr><tr><td style=text-align:right>[n:]</td><td>显示最近执行的 n 条指令</td></tr></tbody></table></div><h3 id=quit-stop>quit-stop</h3><p>退出当前 Arthas 客户端，其他 Arthas 客户端不受影响。等同于 exit、logout、q 三个指令。</p><blockquote><p><strong>提示</strong></p><p>只是退出当前 Arthas 客户端，Arthas 的服务器端并没有关闭，所做的修改也不会被重置。</p></blockquote><h3 id=keymap>keymap</h3><p><code>keymap</code> 命令输出当前的快捷键映射表：</p><div class=table-wrapper><table><thead><tr><th>快捷键</th><th>快捷键说明</th><th>命令名称</th><th>命令说明</th></tr></thead><tbody><tr><td>&ldquo;\C-a&rdquo;</td><td>ctrl + a</td><td>beginning-of-line</td><td>跳到行首</td></tr><tr><td>&ldquo;\C-e&rdquo;</td><td>ctrl + e</td><td>end-of-line</td><td>跳到行尾</td></tr><tr><td>&ldquo;\C-f&rdquo;</td><td>ctrl + f</td><td>forward-word</td><td>向前移动一个单词</td></tr><tr><td>&ldquo;\C-b&rdquo;</td><td>ctrl + b</td><td>backward-word</td><td>向后移动一个单词</td></tr><tr><td>&ldquo;\e[D&rdquo;</td><td>键盘左方向键</td><td>backward-char</td><td>光标向前移动一个字符</td></tr><tr><td>&ldquo;\e[C&rdquo;</td><td>键盘右方向键</td><td>forward-char</td><td>光标向后移动一个字符</td></tr><tr><td>&ldquo;\e[B&rdquo;</td><td>键盘下方向键</td><td>next-history</td><td>下翻显示下一个命令</td></tr><tr><td>&ldquo;\e[A&rdquo;</td><td>键盘上方向键</td><td>previous-history</td><td>上翻显示上一个命令</td></tr><tr><td>&ldquo;\C-h&rdquo;</td><td>ctrl + h</td><td>backward-delete-char</td><td>向后删除一个字符</td></tr><tr><td>&ldquo;\C-?&rdquo;</td><td>ctrl + shift + /</td><td>backward-delete-char</td><td>向后删除一个字符</td></tr><tr><td>&ldquo;\C-u&rdquo;</td><td>ctrl + u</td><td>undo</td><td>撤销上一个命令，相当于清空当前行</td></tr><tr><td>&ldquo;\C-d&rdquo;</td><td>ctrl + d</td><td>delete-char</td><td>删除当前光标所在字符</td></tr><tr><td>&ldquo;\C-k&rdquo;</td><td>ctrl + k</td><td>kill-line</td><td>删除当前光标到行尾的所有字符</td></tr><tr><td>&ldquo;\C-i&rdquo;</td><td>ctrl + i</td><td>complete</td><td>自动补全，相当于敲 TAB</td></tr><tr><td>&ldquo;\C-j&rdquo;</td><td>ctrl + j</td><td>accept-line</td><td>结束当前行，相当于敲回车</td></tr><tr><td>&ldquo;\C-m&rdquo;</td><td>ctrl + m</td><td>accept-line</td><td>结束当前行，相当于敲回车</td></tr><tr><td>&ldquo;\C-w&rdquo;</td><td>-</td><td>backward-delete-word</td><td>-</td></tr><tr><td>&ldquo;\C-x\e[3~&rdquo;</td><td>-</td><td>backward-kill-line</td><td>-</td></tr><tr><td>&ldquo;\e\C-?&rdquo;</td><td>-</td><td>backward-kill-word</td><td>-</td></tr></tbody></table></div><ul><li>任何时候 tab 键，会根据当前的输入给出提示</li><li>命令后敲 - 或 &ndash; ，然后按 tab 键，可以展示出此命令具体的选项</li></ul><h4 id=自定义快捷键>自定义快捷键</h4><p>在当前用户目录下新建 <code>$USER_HOME/.arthas/conf/inputrc</code> 文件，加入自定义配置。</p><h4 id=后台异步命令相关快捷键>后台异步命令相关快捷键</h4><p>ctrl + c: 终止当前命令
ctrl + z: 挂起当前命令，后续可以 bg/fg 重新支持此命令，或 kill 掉
ctrl + a: 回到行首
ctrl + e: 回到行尾</p><h3 id=cat>cat</h3><blockquote><p><strong>提示</strong></p><p>打印文件内容，和 linux 里的 cat 命令类似。</p></blockquote><h3 id=echo>echo</h3><blockquote><p><strong>提示</strong></p><p>打印参数，和 linux 里的 echo 命令类似。</p></blockquote><h3 id=grep>grep</h3><blockquote><p><strong>提示</strong></p><p>类似传统的 grep 命令。</p></blockquote><h3 id=tee>tee</h3><blockquote><p><strong>提示</strong></p><p>类似传统的 tee 命令, 用于读取标准输入的数据，并将其内容输出成文件。</p><p>tee 指令会从标准输入设备读取数据，将其内容输出到标准输出设备，同时保存成文件。</p></blockquote><h3 id=pwd>pwd</h3><blockquote><p><strong>提示</strong></p><p>返回当前的工作目录，和 linux 命令类似</p></blockquote><h3 id=plaintext>plaintext</h3><h3 id=wc>wc</h3><h3 id=options>options</h3><blockquote><p><strong>提示</strong></p><p>全局开关</p></blockquote><div class=table-wrapper><table><thead><tr><th>名称</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>unsafe</td><td>false</td><td>是否支持对系统级别的类进行增强，打开该开关可能导致把 JVM 搞挂，请慎重选择！</td></tr><tr><td>dump</td><td>false</td><td>是否支持被增强了的类 dump 到外部文件中，如果打开开关，class 文件会被 dump 到/${application working dir}/arthas-class-dump/目录下，具体位置详见控制台输出</td></tr><tr><td>batch-re-transform</td><td>true</td><td>是否支持批量对匹配到的类执行 retransform 操作</td></tr><tr><td>json-format</td><td>false</td><td>是否支持 json 化的输出</td></tr><tr><td>disable-sub-class</td><td>false</td><td>是否禁用子类匹配，默认在匹配目标类的时候会默认匹配到其子类，如果想精确匹配，可以关闭此开关</td></tr><tr><td>support-default-method</td><td>true</td><td>是否支持匹配到 default method， 默认会查找 interface，匹配里面的 default method。参考 #1105 在新窗口打开</td></tr><tr><td>save-result</td><td>false</td><td>是否打开执行结果存日志功能，打开之后所有命令的运行结果都将保存到~/logs/arthas-cache/result.log 中</td></tr><tr><td>job-timeout</td><td>1d</td><td>异步后台任务的默认超时时间，超过这个时间，任务自动停止；比如设置 1d, 2h, 3m, 25s，分别代表天、小时、分、秒</td></tr><tr><td>print-parent-fields</td><td>true</td><td>是否打印在 parent class 里的 filed</td></tr><tr><td>verbose</td><td>false</td><td>是否打印更多详细信息</td></tr><tr><td>strict</td><td>true</td><td>是否启用 strict 模式</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 查看所有的 options</span>
</span></span><span class=line><span class=cl>options
</span></span><span class=line><span class=cl><span class=c1># 获取 option 的值</span>
</span></span><span class=line><span class=cl>options json-format
</span></span><span class=line><span class=cl><span class=c1># 设置指定的 option</span>
</span></span><span class=line><span class=cl>options save-result <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>提示</strong></p><p>默认情况下 <code>json-format</code> 为 false，如果希望 <code>watch</code>/<code>tt</code> 等命令结果以 json 格式输出，则可以设置 <code>json-format</code> 为 true。</p></blockquote><h4 id=打开-unsafe-开关支持-jdk-package-下的类>打开 unsafe 开关，支持 jdk package 下的类</h4><p>默认情况下，<code>watch</code>/<code>trace</code>/<code>tt</code>/<code>trace</code>/<code>monitor</code> 等命令不支持 <code>java.\*</code> package 下的类。可以设置 <code>unsafe</code> 为 true，则可以增强。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>options unsafe <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=关闭-strict-模式允许在-ognl-表达式里设置对象属性>关闭 strict 模式，允许在 ognl 表达式里设置对象属性</h4><blockquote><p><strong>提示</strong></p><p>since 3.6.0</p></blockquote><p>对于新用户，在编写 ognl 表达式时，可能会出现误用。</p><p>比如对于 <code>Student</code>，判断年龄等于 18 时，可能条件表达式会误写为 <code>target.age=18</code>，这个表达式实际上是把当前对象的 <code>age</code> 设置为 18 了。正确的写法是 <code>target.age==18</code>。</p><p>为了防止出现类似上面的误用，Arthas 默认启用 <code>strict</code> 模式，在 <code>ognl</code> 表达式里，禁止更新对象的 Property 或者调用 <code>setter</code> 函数。</p><p>以 <code>MathGame</code> 为例，会出现以下的错误提示。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors <span class=s1>&#39;target&#39;</span> <span class=s1>&#39;target.illegalArgumentCount=1&#39;</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>20</span> ms, listenerId: <span class=m>6</span>
</span></span><span class=line><span class=cl>watch failed, condition is: target.illegalArgumentCount<span class=o>=</span>1, express is: target, By default, strict mode is true, not allowed to <span class=nb>set</span> object properties. Want to <span class=nb>set</span> object properties, execute <span class=sb>`</span>options strict <span class=nb>false</span><span class=sb>`</span>, visit /Users/lucaschen/logs/arthas/arthas.log <span class=k>for</span> more details.
</span></span></code></pre></td></tr></table></div></div><p>用户如果确定要在 <code>ognl</code> 表达式里更新对象，可以执行 <code>options strict false</code>，关闭 strict 模式。</p><h2 id=系统命令>系统命令</h2><h3 id=dashboard>dashboard</h3><blockquote><p><strong>提示</strong></p></blockquote><p>当前系统的实时数据面板，按 ctrl+c 退出。</p><p>当运行在 Ali-tomcat 时，会显示当前 tomcat 的实时信息，如 HTTP 请求的 qps, rt, 错误数, 线程池信息等等。</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right>[i:]</td><td>刷新实时数据的时间间隔 (ms)，默认 5000ms</td></tr><tr><td style=text-align:right>[n:]</td><td>刷新实时数据的次数</td></tr></tbody></table></div><p><img src=/post/arthas/dashboard.png width=1209 height=920 srcset="/post/arthas/dashboard_hu_bb153b684e218245.png 480w, /post/arthas/dashboard_hu_612f3b3392d45954.png 1024w" loading=lazy alt=dashboard class=gallery-image data-flex-grow=131 data-flex-basis=315px></p><h4 id=数据说明>数据说明</h4><ul><li>ID: Java 级别的线程 ID，注意这个 ID 不能跟 jstack 中的 nativeID 一一对应。</li><li>NAME: 线程名</li><li>GROUP: 线程组名</li><li>PRIORITY: 线程优先级, 1~10 之间的数字，越大表示优先级越高</li><li>STATE: 线程的状态</li><li>CPU%: 线程的 cpu 使用率。比如采样间隔 1000ms，某个线程的增量 cpu 时间为 100ms，则 cpu 使用率=100/1000=10%</li><li>DELTA_TIME: 上次采样之后线程运行增量 CPU 时间，数据格式为<code>秒</code></li><li>TIME: 线程运行总 CPU 时间，数据格式为<code>分:秒</code></li><li>INTERRUPTED: 线程当前的中断位状态</li><li>DAEMON: 是否是 daemon 线程</li></ul><h4 id=jvm-内部线程>JVM 内部线程</h4><p>Java 8 之后支持获取 JVM 内部线程 CPU 时间，这些线程只有名称和 CPU 时间，没有 ID 及状态等信息（显示 ID 为-1）。 通过内部线程可以观测到 JVM 活动，如 GC、JIT 编译等占用 CPU 情况，方便了解 JVM 整体运行状况。</p><ul><li>当 JVM 堆(heap)/元数据(metaspace)空间不足或 OOM 时，可以看到 GC 线程的 CPU 占用率明显高于其他的线程。</li><li>当执行 <code>trace/watch/tt/redefine</code> 等命令后，可以看到 JIT 线程活动变得更频繁。因为 JVM 热更新 class 字节码时清除了此 class 相关的 JIT 编译结果，需要重新编译。</li></ul><p>JVM 内部线程包括下面几种：</p><ul><li>JIT 编译线程: 如 <code>C1 CompilerThread0</code>, <code>C2 CompilerThread0</code></li><li>GC 线程: 如 <code>GC Thread0</code>, <code>G1 Young RemSet Sampling</code></li><li>其它内部线程: 如 <code>VM Periodic Task Thread</code>, <code>VM Thread</code>, <code>Service Thread</code></li></ul><h3 id=thread>thread</h3><blockquote><p><strong>提示</strong></p><p>查看当前线程信息，查看线程的堆栈</p></blockquote><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right>id</td><td>线程 id</td></tr><tr><td style=text-align:right>[n:]</td><td>指定最忙的前 N 个线程并打印堆栈</td></tr><tr><td style=text-align:right>[b]</td><td>找出当前阻塞其他线程的线程</td></tr><tr><td style=text-align:right>[i &lt;value>]</td><td>指定 cpu 使用率统计的采样间隔，单位为毫秒，默认值为 200</td></tr><tr><td style=text-align:right>[&ndash;all]</td><td>显示所有匹配的线程</td></tr></tbody></table></div><p>这里的 cpu 使用率与 linux 命令 <code>top -H -p &lt;pid></code> 的线程 <code>%CPU</code> 类似，一段采样间隔时间内，当前 JVM 里各个线程的增量 cpu 时间与采样间隔时间的比例。</p><p>工作原理说明：</p><ul><li>首先第一次采样，获取所有线程的 CPU 时间(调用的是 <code>java.lang.management.ThreadMXBean#getThreadCpuTime()</code> 及 <code>sun.management.HotspotThreadMBean.getInternalThreadCpuTimes()</code> 接口)</li><li>然后睡眠等待一个间隔时间（默认为 200ms，可以通过 <code>-i</code> 指定间隔时间）</li><li>再次第二次采样，获取所有线程的 CPU 时间，对比两次采样数据，计算出每个线程的增量 CPU 时间</li><li>线程 CPU 使用率 = 线程增量 CPU 时间 / 采样间隔时间 * 100%</li></ul><blockquote><p><strong>注意</strong></p><p>注意： 这个统计也会产生一定的开销（JDK 这个接口本身开销比较大），因此会看到 as 的线程占用一定的百分比，为了降低统计自身的开销带来的影响，可以把采样间隔拉长一些，比如 5000 毫秒。</p><p><strong>提示</strong></p><p>另外一种查看 Java 进程的线程 cpu 使用率方法：可以使用 show-busy-java-threads 这个脚本</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 一键展示当前最忙的前 N 个线程并打印堆栈</span>
</span></span><span class=line><span class=cl>thread -n <span class=m>3</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>没有线程 ID，包含 <code>[Internal]</code>表示为 JVM 内部线程，参考 <a class=link href=#dashboard>dashboard</a> 命令的介绍。</li><li><code>cpuUsage</code> 为采样间隔时间内线程的 CPU 使用率，与 <a class=link href=#dashboard>dashboard</a> 命令的数据一致。</li><li><code>deltaTime</code> 为采样间隔时间内线程的增量 CPU 时间，小于 1ms 时被取整显示为 0ms。</li><li><code>time</code> 线程运行总 CPU 时间。</li></ul><p>注意：线程栈为第二采样结束时获取，不能表明采样间隔时间内该线程都是在处理相同的任务。建议间隔时间不要太长，可能间隔时间越大越不准确。 可以根据具体情况尝试指定不同的间隔时间，观察输出结果。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 当没有参数时，显示第一页线程的信息</span>
</span></span><span class=line><span class=cl><span class=c1># 默认按照 CPU 增量时间降序排列，只显示第一页数据。</span>
</span></span><span class=line><span class=cl>thread
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显示所有匹配线程信息，有时需要获取全部 JVM 的线程数据进行分析。</span>
</span></span><span class=line><span class=cl>thread --all
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># thread id, 显示指定线程的运行堆栈</span>
</span></span><span class=line><span class=cl>thread <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># thread -b, 找出当前阻塞其他线程的线程</span>
</span></span><span class=line><span class=cl><span class=c1># 有时候我们发现应用卡住了， 通常是由于某个线程拿住了某个锁， 并且其他线程都在等待这把锁造成的。 为了排查这类问题， arthas 提供了 thread -b， 一键找出那个罪魁祸首</span>
</span></span><span class=line><span class=cl><span class=c1># **注意**</span>
</span></span><span class=line><span class=cl><span class=c1># 注意， 目前只支持找出 synchronized 关键字阻塞住的线程， 如果是java.util.concurrent.Lock， 目前还不支持</span>
</span></span><span class=line><span class=cl>thread -b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># thread -i, 指定采样时间间隔</span>
</span></span><span class=line><span class=cl><span class=c1># 统计最近 1000ms 内的线程 CPU 时间</span>
</span></span><span class=line><span class=cl>thread -i <span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=c1># 列出 1000ms 内最忙的 3 个线程栈</span>
</span></span><span class=line><span class=cl>thread -n <span class=m>3</span> -i <span class=m>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># thread --state ，查看指定状态的线程</span>
</span></span><span class=line><span class=cl><span class=c1># NEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATED</span>
</span></span><span class=line><span class=cl>thread --state WAITING
</span></span></code></pre></td></tr></table></div></div><h3 id=jvm>jvm</h3><blockquote><p><strong>提示</strong></p><p>查看当前 JVM 信息</p></blockquote><p>THREAD 相关:</p><ul><li>COUNT: JVM 当前活跃的线程数</li><li>DAEMON-COUNT: JVM 当前活跃的守护线程数</li><li>PEAK-COUNT: 从 JVM 启动开始曾经活着的最大线程数</li><li>STARTED-COUNT: 从 JVM 启动开始总共启动过的线程次数</li><li>DEADLOCK-COUNT: JVM 当前死锁的线程数</li></ul><p>文件描述符相关:</p><ul><li>MAX-FILE-DESCRIPTOR-COUNT：JVM 进程最大可以打开的文件描述符数</li><li>OPEN-FILE-DESCRIPTOR-COUNT：JVM 当前打开的文件描述符数</li></ul><h3 id=sysprop>sysprop</h3><blockquote><p><strong>提示</strong></p><p>查看当前 JVM 的系统属性(System Property)</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 查看所有属性</span>
</span></span><span class=line><span class=cl>sysprop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看单个属性, 支持通过TAB键自动补全</span>
</span></span><span class=line><span class=cl>sysprop java.version
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改单个属性</span>
</span></span><span class=line><span class=cl>sysprop user.country CN
</span></span></code></pre></td></tr></table></div></div><h3 id=sysenv>sysenv</h3><blockquote><p><strong>提示</strong></p><p>查看当前 JVM 的环境属性(System Environment Variables)</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 查看所有环境变量</span>
</span></span><span class=line><span class=cl>sysenv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看单个环境变量, 支持通过TAB键自动补全</span>
</span></span><span class=line><span class=cl>sysenv java.version
</span></span></code></pre></td></tr></table></div></div><h3 id=vmoption>vmoption</h3><blockquote><p><strong>提示</strong></p><p>查看，更新 VM 诊断相关的参数</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 查看所有的 option</span>
</span></span><span class=line><span class=cl>vmoption
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看指定的 option</span>
</span></span><span class=line><span class=cl>vmoption PrintGC
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 更新指定的 option</span>
</span></span><span class=line><span class=cl>vmoption PrintGCDetails <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=vmtool>vmtool</h3><blockquote><p><strong>提示</strong></p><p>@since 3.5.1</p></blockquote><p><code>vmtool</code> 利用 <code>JVMTI</code> 接口，实现查询内存对象，强制 GC 等功能。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 获取对象</span>
</span></span><span class=line><span class=cl><span class=c1># 通过 --limit参数，可以限制返回值数量，避免获取超大数据时对 JVM 造成压力。默认值是 10。</span>
</span></span><span class=line><span class=cl>vmtool --action getInstances --className java.lang.String --limit <span class=m>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 指定 classloader name</span>
</span></span><span class=line><span class=cl>vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className org.springframework.context.ApplicationContext
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 指定 classloader hash</span>
</span></span><span class=line><span class=cl><span class=c1>#可以通过sc命令查找到加载 class 的 classloader。</span>
</span></span><span class=line><span class=cl>sc -d org.springframework.context.ApplicationContext
</span></span><span class=line><span class=cl> class-info        org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext
</span></span><span class=line><span class=cl> code-source       file:/private/tmp/demo-arthas-spring-boot.jar!/BOOT-INF/lib/spring-boot-1.5.13.RELEASE.jar!/
</span></span><span class=line><span class=cl> name              org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl> class-loader      +-org.springframework.boot.loader.LaunchedURLClassLoader@19469ea2
</span></span><span class=line><span class=cl>                     +-sun.misc.Launcher<span class=nv>$AppClassLoader</span>@75b84c92
</span></span><span class=line><span class=cl>                       +-sun.misc.Launcher<span class=nv>$ExtClassLoader</span>@4f023edb
</span></span><span class=line><span class=cl> classLoaderHash   19469ea2
</span></span><span class=line><span class=cl><span class=c1># 然后用-c/--classloader 参数指定：</span>
</span></span><span class=line><span class=cl>vmtool --action getInstances -c 19469ea2 --className org.springframework.context.ApplicationContext
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 指定返回结果展开层数</span>
</span></span><span class=line><span class=cl><span class=c1># getInstances action 返回结果绑定到instances变量上，它是数组。</span>
</span></span><span class=line><span class=cl><span class=c1># 通过 -x/--expand 参数可以指定结果的展开层次，默认值是 1。</span>
</span></span><span class=line><span class=cl>vmtool --action getInstances -c 19469ea2 --className org.springframework.context.ApplicationContext -x <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行表达式</span>
</span></span><span class=line><span class=cl><span class=c1># getInstances action 返回结果绑定到instances变量上，它是数组。可以通过--express参数执行指定的表达式。</span>
</span></span><span class=line><span class=cl>vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className org.springframework.context.ApplicationContext --express <span class=s1>&#39;instances[0].getBeanDefinitionNames()&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 强制 GC</span>
</span></span><span class=line><span class=cl><span class=c1># 可以结合 vmoption 命令动态打开PrintGC开关</span>
</span></span><span class=line><span class=cl>vmtool --action forceGc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># interrupt 指定线程</span>
</span></span><span class=line><span class=cl><span class=c1># thread id 通过-t参数指定，可以使用 thread 命令获取。</span>
</span></span><span class=line><span class=cl>vmtool --action interruptThread -t <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=perfcounter>perfcounter</h3><blockquote><p><strong>提示</strong></p><p>查看当前 JVM 的 Perf Counter 信息</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>perfcounter
</span></span><span class=line><span class=cl><span class=c1># 可以用-d参数打印更多信息：</span>
</span></span><span class=line><span class=cl>perfcounter -d
</span></span></code></pre></td></tr></table></div></div><p>jdk9 以上的应用,如果没有打印出信息，应用在启动时，加下面的参数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>--add-opens java.base/jdk.internal.perf<span class=o>=</span>ALL-UNNAMED --add-exports java.base/jdk.internal.perf<span class=o>=</span>ALL-UNNAMED --add-opens java.management/sun.management.counter.perf<span class=o>=</span>ALL-UNNAMED --add-opens java.management/sun.management.counter<span class=o>=</span>ALL-UNNAMED
</span></span></code></pre></td></tr></table></div></div><h3 id=logger>logger</h3><blockquote><p><strong>提示</strong></p><p>查看 logger 信息，更新 logger level</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 更新 logger level</span>
</span></span><span class=line><span class=cl>logger --name ROOT --level debug
</span></span></code></pre></td></tr></table></div></div><h3 id=getstatic>getstatic</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 通过 getstatic 命令可以方便的查看类的静态属性。使用方法为 `getstatic class_name field_name`</span>
</span></span><span class=line><span class=cl>getstatic demo.MathGame random
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，使用sc -d &lt;ClassName&gt;提取对应 ClassLoader 的 hashcode。</span>
</span></span><span class=line><span class=cl><span class=c1># 如果你使用-c，你需要手动输入 hashcode：-c &lt;hashcode&gt;</span>
</span></span><span class=line><span class=cl>getstatic -c 3d4eac69 demo.MathGame random
</span></span><span class=line><span class=cl><span class=c1># 对于只有唯一实例的 ClassLoader 可以通过--classLoaderClass指定 class name，使用起来更加方便：</span>
</span></span><span class=line><span class=cl>getstatic --classLoaderClass sun.misc.Launcher<span class=nv>$AppClassLoader</span> demo.MathGame random
</span></span></code></pre></td></tr></table></div></div><h3 id=ognl>ognl</h3><blockquote><p><strong>提示</strong></p><p>执行 ognl 表达式</p></blockquote><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right>express</td><td>执行的表达式</td></tr><tr><td style=text-align:right>[c:]</td><td>执行表达式的 ClassLoader 的 hashcode，默认值是 SystemClassLoader</td></tr><tr><td style=text-align:right>[classLoaderClass:]</td><td>指定执行表达式的 ClassLoader 的 class name</td></tr><tr><td style=text-align:right>[x]</td><td>结果对象的展开层次，默认值 1</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 调用静态函数：</span>
</span></span><span class=line><span class=cl>ognl <span class=s1>&#39;@java.lang.System@out.println(&#34;hello&#34;)&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># 获取静态类的静态字段：</span>
</span></span><span class=line><span class=cl>ognl <span class=s1>&#39;@demo.MathGame@random&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># 执行多行表达式，赋值给临时变量，返回一个 List：</span>
</span></span><span class=line><span class=cl>$ ognl <span class=s1>&#39;#value1=@System@getProperty(&#34;java.home&#34;), #value2=@System@getProperty(&#34;java.runtime.name&#34;), {#value1, #value2}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>arthas 中的特殊用法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 查看第一个参数：</span>
</span></span><span class=line><span class=cl>watch com.taobao.container.Test <span class=nb>test</span> <span class=s2>&#34;params[0]&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看第一个参数的 size：</span>
</span></span><span class=line><span class=cl>watch com.taobao.container.Test <span class=nb>test</span> <span class=s2>&#34;params[0].size()&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将结果按 name 属性投影：</span>
</span></span><span class=line><span class=cl>watch com.taobao.container.Test <span class=nb>test</span> <span class=s2>&#34;params[0].{ #this.name }&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按条件过滤：</span>
</span></span><span class=line><span class=cl>watch com.taobao.container.Test <span class=nb>test</span> <span class=s2>&#34;params[0].{? #this.name == null }.size() &gt; 0&#34;</span> -x <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 过滤后统计：</span>
</span></span><span class=line><span class=cl>watch com.taobao.container.Test <span class=nb>test</span> <span class=s2>&#34;params[0].{? #this.age &gt; 10 }.size()&#34;</span> -x <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 判断字符串相等</span>
</span></span><span class=line><span class=cl>watch com.demo.Test <span class=nb>test</span> <span class=s1>&#39;params[0]==&#34;xyz&#34;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 判断 long 型</span>
</span></span><span class=line><span class=cl>watch com.demo.Test <span class=nb>test</span> <span class=s1>&#39;params[0]==123456789L&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 子表达式求值：</span>
</span></span><span class=line><span class=cl>watch com.taobao.container.Test <span class=nb>test</span> <span class=s2>&#34;params[0].{? #this.age &gt; 10 }.size().(#this &gt; 20 ? #this - 10 : #this + 10)&#34;</span> -x <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 选择第一个满足条件：</span>
</span></span><span class=line><span class=cl>watch com.taobao.container.Test <span class=nb>test</span> <span class=s2>&#34;params[0].{^ #this.name != null}&#34;</span> -x <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 选择最后一个满足条件：</span>
</span></span><span class=line><span class=cl>watch com.taobao.container.Test <span class=nb>test</span> <span class=s2>&#34;params[0].{</span>$<span class=s2> #this.name != null}&#34;</span> -x <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 匹配线程 &amp; 正则多个类多个方法</span>
</span></span><span class=line><span class=cl>trace -E <span class=s1>&#39;io\.netty\.channel\.nio\.NioEventLoop|io\.netty\.util\.concurrent\.SingleThreadEventExecutor&#39;</span>  <span class=s1>&#39;select|processSelectedKeys|runAllTasks&#39;</span> <span class=s1>&#39;@Thread@currentThread().getName().contains(&#34;IO-HTTP-WORKER-IOPool&#34;)&amp;&amp;#cost&gt;500&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=mbean>mbean</h3><blockquote><p><strong>提示</strong></p><p>查看 Mbean 的信息</p></blockquote><p>这个命令可以便捷的查看或监控 Mbean 的属性信息。</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right>name-pattern</td><td>名称表达式匹配</td></tr><tr><td style=text-align:right>attribute-pattern</td><td>属性名表达式匹配</td></tr><tr><td style=text-align:right>[m]</td><td>查看元信息</td></tr><tr><td style=text-align:right>[i:]</td><td>刷新属性值的时间间隔 (ms)</td></tr><tr><td style=text-align:right>[n:]</td><td>刷新属性值的次数</td></tr><tr><td style=text-align:right>[E]</td><td>开启正则表达式匹配，默认为通配符匹配。仅对属性名有效</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 列出所有 Mbean 的名称：</span>
</span></span><span class=line><span class=cl>mbean
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 Mbean 的元信息：</span>
</span></span><span class=line><span class=cl>mbean -m java.lang:type<span class=o>=</span>Threading
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 mbean 属性信息：</span>
</span></span><span class=line><span class=cl>mbean java.lang:type<span class=o>=</span>Threading
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># mbean 的 name 支持通配符匹配：</span>
</span></span><span class=line><span class=cl><span class=c1># 注意：ObjectName 的匹配规则与正常的通配符存在差异，详细参见：[javax.management.ObjectName](https://docs.oracle.com/javase/8/docs/api/javax/management/ObjectName.html?is-external=true)</span>
</span></span><span class=line><span class=cl>mbean java.lang:type<span class=o>=</span>Th*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通配符匹配特定的属性字段：</span>
</span></span><span class=line><span class=cl>mbean java.lang:type<span class=o>=</span>Threading *Count
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用 -E 命令切换为正则匹配：</span>
</span></span><span class=line><span class=cl>mbean -E java.lang:type<span class=o>=</span>Threading PeakThreadCount<span class=p>|</span>ThreadCount<span class=p>|</span>DaemonThreadCount
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用 -i 命令实时监控：</span>
</span></span><span class=line><span class=cl>mbean -i <span class=m>1000</span> java.lang:type<span class=o>=</span>Threading *Count
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 实时监控使用 -i，使用 -n 命令执行命令的次数（默认为 100 次）：</span>
</span></span><span class=line><span class=cl>mbean -i <span class=m>1000</span> -n <span class=m>50</span> java.lang:type<span class=o>=</span>Threading *Count
</span></span></code></pre></td></tr></table></div></div><h3 id=heapdump>heapdump</h3><blockquote><p><strong>提示</strong></p><p>dump java heap, 类似 jmap 命令的 heap dump 功能。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># dump 到指定文件</span>
</span></span><span class=line><span class=cl><span class=c1># 生成文件在arthas-output目录，可以通过浏览器下载： http://localhost:8563/arthas-output/</span>
</span></span><span class=line><span class=cl>heapdump arthas-output/dump.hprof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 只 dump live 对象</span>
</span></span><span class=line><span class=cl>heapdump --live /tmp/dump.hprof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># dump 到临时文件</span>
</span></span><span class=line><span class=cl>heapdump
</span></span></code></pre></td></tr></table></div></div><h2 id=类命令>类命令</h2><h3 id=sc>sc</h3><blockquote><p><strong>提示</strong></p><p>查看 JVM 已加载的类信息</p></blockquote><p>“Search-Class” 的简写，这个命令能搜索出所有已经加载到 JVM 中的 Class 信息，这个命令支持的参数有 <code>[d]</code>、<code>[E]</code>、<code>[f]</code> 和 <code>[x:]</code>。</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>class-pattern</em></td><td>类名表达式匹配</td></tr><tr><td style=text-align:right><em>method-pattern</em></td><td>方法名表达式匹配</td></tr><tr><td style=text-align:right>[d]</td><td>输出当前类的详细信息，包括这个类所加载的原始文件来源、类的声明、加载的 ClassLoader 等详细信息。如果一个类被多个 ClassLoader 所加载，则会出现多次</td></tr><tr><td style=text-align:right>[E]</td><td>开启正则表达式匹配，默认为通配符匹配</td></tr><tr><td style=text-align:right>[f]</td><td>输出当前类的成员变量信息（需要配合参数-d 一起使用）</td></tr><tr><td style=text-align:right>[x:]</td><td>指定输出静态变量时属性的遍历深度，默认为 0，即直接使用 toString 输出</td></tr><tr><td style=text-align:right>[c:]</td><td>指定 class 的 ClassLoader 的 hashcode</td></tr><tr><td style=text-align:right>[classLoaderClass:]</td><td>指定执行表达式的 ClassLoader 的 class name</td></tr><tr><td style=text-align:right>[n:]</td><td>具有详细信息的匹配类的最大数量（默认为 100）</td></tr><tr><td style=text-align:right>[cs &lt;arg>]</td><td>指定 class 的 ClassLoader#toString() 返回值。长格式[classLoaderStr &lt;arg>]</td></tr></tbody></table></div><blockquote><p><em>提示</em></p><p>class-pattern 支持全限定名，如 <code>com.taobao.test.AAA</code>，也支持 <code>com/taobao/test/AAA</code> 这样的格式，这样，我们从异常堆栈里面把类名拷贝过来的时候，不需要在手动把 <code>/</code> 替换为 <code>.</code> 啦。</p><p>sc 默认开启了子类匹配功能，也就是说所有当前类的子类也会被搜索出来，想要精确的匹配，请打开 <code>options disable-sub-class true</code> 开关</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 模糊搜索</span>
</span></span><span class=line><span class=cl>sc demo.*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印类的详细信息</span>
</span></span><span class=line><span class=cl>sc -d demo.MathGame
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印出类的 Field 信息</span>
</span></span><span class=line><span class=cl>sc -d -f demo.MathGame
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通过 ClassLoader#toString 查找类（前提：有一个 toString()返回值是apo的类加载器，加载的类中包含 `demo.MathGame`, `demo.MyBar`, `demo.MyFoo3` 个类）</span>
</span></span><span class=line><span class=cl>sc -cs apo *demo*
</span></span></code></pre></td></tr></table></div></div><h3 id=sm>sm</h3><blockquote><p><strong>提示</strong></p><p>查看已加载类的方法信息</p></blockquote><p>“Search-Method” 的简写，这个命令能搜索出所有已经加载了 Class 信息的方法信息。</p><p><code>sm</code> 命令只能看到由当前类所声明 (declaring) 的方法，父类则无法看到。</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>class-pattern</em></td><td>类名表达式匹配</td></tr><tr><td style=text-align:right><em>method-pattern</em></td><td>方法名表达式匹配</td></tr><tr><td style=text-align:right>[d]</td><td>展示每个方法的详细信息</td></tr><tr><td style=text-align:right>[E]</td><td>开启正则表达式匹配，默认为通配符匹配</td></tr><tr><td style=text-align:right>[c:]</td><td>指定 class 的 ClassLoader 的 hashcode</td></tr><tr><td style=text-align:right>[classLoaderClass:]</td><td>指定执行表达式的 ClassLoader 的 class name</td></tr><tr><td style=text-align:right>[n:]</td><td>具有详细信息的匹配类的最大数量（默认为 100）</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sm java.lang.String
</span></span><span class=line><span class=cl>sm -d java.lang.String toString
</span></span></code></pre></td></tr></table></div></div><h3 id=jad>jad</h3><blockquote><p><strong>提示</strong></p><p>反编译指定已加载类的源码</p></blockquote><p><code>jad</code> 命令将 JVM 中实际运行的 class 的 byte code 反编译成 java 代码，便于你理解业务逻辑；如需批量下载指定包的目录的 class 字节码可以参考 dump。</p><ul><li>在 Arthas Console 上，反编译出来的源码是带语法高亮的，阅读更方便</li><li>当然，反编译出来的 java 代码可能会存在语法错误，但不影响你进行阅读理解</li></ul><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>class-pattern</em></td><td>类名表达式匹配</td></tr><tr><td style=text-align:right>[c:]</td><td>类所属 ClassLoader 的 hashcode</td></tr><tr><td style=text-align:right>[classLoaderClass:]</td><td>指定执行表达式的 ClassLoader 的 class name</td></tr><tr><td style=text-align:right>[E]</td><td>开启正则表达式匹配，默认为通配符匹配</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 反编译java.lang.String</span>
</span></span><span class=line><span class=cl>jad java.lang.String
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 反编译时只显示源代码</span>
</span></span><span class=line><span class=cl><span class=c1># 默认情况下，反编译结果里会带有 ClassLoader 信息，通过 --source-only 选项，可以只打印源代码。方便和 mc/retransform 命令结合使用</span>
</span></span><span class=line><span class=cl>jad --source-only demo.MathGame
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 反编译指定的函数</span>
</span></span><span class=line><span class=cl>jad demo.MathGame main
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 反编译时不显示行号</span>
</span></span><span class=line><span class=cl><span class=c1># --lineNumber 参数默认值为 true，显示指定为 false 则不打印行号。</span>
</span></span><span class=line><span class=cl>jad demo.MathGame main --lineNumber <span class=nb>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 反编译时指定 ClassLoader</span>
</span></span><span class=line><span class=cl><span class=c1># 当有多个 ClassLoader 都加载了这个类时，jad 命令会输出对应 ClassLoader 实例的 hashcode，然后你只需要重新执行 jad 命令，并使用参数 -c &lt;hashcode&gt; 就可以反编译指定 ClassLoader 加载的那个类了；</span>
</span></span><span class=line><span class=cl>jad org.apache.log4j.Logger
</span></span><span class=line><span class=cl><span class=c1># 对于只有唯一实例的 ClassLoader 还可以通过--classLoaderClass指定 class name，使用起来更加方便：</span>
</span></span><span class=line><span class=cl><span class=c1># --classLoaderClass 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而-c &lt;hashcode&gt;是动态变化的。</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=mc-retransform>mc-retransform</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&gt; **提示**
</span></span><span class=line><span class=cl>&gt;
</span></span><span class=line><span class=cl>&gt; 加载外部的.class文件，retransform jvm 已加载的类。
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># retransform 指定的 .class 文件</span>
</span></span><span class=line><span class=cl><span class=c1># 加载指定的 .class 文件，然后解析出 class name，再 retransform jvm 中已加载的对应的类。每加载一个 .class 文件，则会记录一个 retransform entry.</span>
</span></span><span class=line><span class=cl><span class=c1># 如果多次执行 retransform 加载同一个 class 文件，则会有多条 retransform entry.</span>
</span></span><span class=line><span class=cl>retransform /tmp/Test.class
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 retransform entry</span>
</span></span><span class=line><span class=cl><span class=c1># TransformCount 统计在 ClassFileTransformer#transform 函数里尝试返回 entry 对应的 .class 文件的次数，但并不表明 transform 一定成功。</span>
</span></span><span class=line><span class=cl>retransform -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除指定 retransform entry</span>
</span></span><span class=line><span class=cl><span class=c1># 需要指定 id：</span>
</span></span><span class=line><span class=cl>retransform -d <span class=m>1</span>                    <span class=c1># delete retransform entry</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除所有 retransform entry</span>
</span></span><span class=line><span class=cl>retransform --deleteAll             <span class=c1># delete all retransform entries</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显式触发 retransform</span>
</span></span><span class=line><span class=cl><span class=c1># 注意：对于同一个类，当存在多个 retransform entry 时，如果显式触发 retransform ，则最后添加的 entry 生效(id 最大的)。</span>
</span></span><span class=line><span class=cl>retransform --classPattern demo.*   <span class=c1># triger retransform classes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>retransform -c 327a647b /tmp/Test.class /tmp/Test<span class=se>\$</span>Inner.class
</span></span><span class=line><span class=cl>retransform --classLoaderClass <span class=s1>&#39;sun.misc.Launcher$AppClassLoader&#39;</span> /tmp/Test.class
</span></span></code></pre></td></tr></table></div></div><h4 id=如果对某个类执行-retransform-之后想消除影响则需要>如果对某个类执行 retransform 之后，想消除影响，则需要</h4><ul><li>删除这个类对应的 retransform entry</li><li>重新触发 retransform</li></ul><blockquote><p><strong>提示</strong></p><p>如果不清除掉所有的 retransform entry，并重新触发 retransform ，则 arthas stop 时，retransform 过的类仍然生效。</p></blockquote><h4 id=结合-jadmc-命令使用>结合 jad/mc 命令使用</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mc /tmp/UserController.java -d /tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>retransform /tmp/com/example/demo/arthas/user/UserController.class
</span></span></code></pre></td></tr></table></div></div><ul><li>jad 命令反编译，然后可以用其它编译器，比如 vim 来修改源码</li><li>mc 命令来内存编译修改过的代码</li><li>用 retransform 命令加载新的字节码</li></ul><h4 id=上传-class-文件到服务器的技巧>上传 .class 文件到服务器的技巧</h4><p>使用 mc 命令来编译 jad 的反编译的代码有可能失败。可以在本地修改代码，编译好后再上传到服务器上。有的服务器不允许直接上传文件，可以使用 base64 命令来绕过。</p><ol><li>在本地先转换.class 文件为 base64，再保存为 result.txt</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>base64 &lt; Test.class &gt; result.txt
</span></span></code></pre></td></tr></table></div></div><ol start=2><li><p>到服务器上，新建并编辑 result.txt，复制本地的内容，粘贴再保存</p></li><li><p>把服务器上的 result.txt 还原为.class</p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>base64 -d &lt; result.txt &gt; Test.class
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>用 md5 命令计算哈希值，校验是否一致</li></ol><hr><p>retransform 的限制</p><ul><li>不允许新增加 field/method</li><li>正在跑的函数，没有退出不能生效，比如下面新增加的 <code>System.out.println</code>，只有 <code>run()</code> 函数里的会生效</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MathGame</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MathGame</span><span class=w> </span><span class=n>game</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MathGame</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>game</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 这个不生效，因为代码一直跑在 while里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;in loop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这个生效，因为run()函数每次都可以完整结束</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;call run()&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>primeFactors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>primeFactors</span><span class=p>(</span><span class=n>number</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>print</span><span class=p>(</span><span class=n>number</span><span class=p>,</span><span class=w> </span><span class=n>primeFactors</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;illegalArgumentCount:%3d, &#34;</span><span class=p>,</span><span class=w> </span><span class=n>illegalArgumentCount</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=mc-redefine>mc-redefine</h3><blockquote><p><strong>提示</strong></p><p>推荐使用 <a class=link href=#mc-retransform>retransform</a> 命令</p></blockquote><h3 id=dump>dump</h3><blockquote><p><strong>提示</strong></p><p>dump 已加载类的 bytecode 到特定目录</p></blockquote><p>dump 命令将 JVM 中实际运行的 class 的 byte code dump 到指定目录，适用场景批量下载指定包目录的 class 字节码；如需反编译单一类、实时查看类信息，可参考 <a class=link href=#jad>jad</a>。</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>class-pattern</em></td><td>类名表达式匹配</td></tr><tr><td style=text-align:right>[c:]</td><td>类所属 ClassLoader 的 hashcode</td></tr><tr><td style=text-align:right>[classLoaderClass:]</td><td>指定执行表达式的 ClassLoader 的 class name</td></tr><tr><td style=text-align:right>[d:]</td><td>设置类文件的目标目录</td></tr><tr><td style=text-align:right>[E]</td><td>开启正则表达式匹配，默认为通配符匹配</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>dump java.lang.String
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dump demo.*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dump -d /tmp/output java.lang.String
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 指定 classLoader</span>
</span></span><span class=line><span class=cl><span class=c1># 如果你使用 -c，你需要手动输入 hashcode：-c &lt;hashcode&gt;</span>
</span></span><span class=line><span class=cl>dump -c 3d4eac69 demo.*
</span></span><span class=line><span class=cl><span class=c1># 对于只有唯一实例的 ClassLoader 可以通过--classLoaderClass指定 class name，使用起来更加方便：</span>
</span></span><span class=line><span class=cl>dump --classLoaderClass sun.misc.Launcher<span class=nv>$AppClassLoader</span> demo.*
</span></span></code></pre></td></tr></table></div></div><h3 id=classloader>classloader</h3><blockquote><p><strong>提示</strong></p><p>查看 classloader 的继承树，urls，类加载信息</p></blockquote><p><code>classloader</code> 命令将 JVM 中所有的 classloader 的信息统计出来，并可以展示继承树，urls 等。</p><p>可以让指定的 classloader 去 getResources，打印出所有查找到的 resources 的 url。对于 <code>ResourceNotFoundException</code> 比较有用。</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right>[l]</td><td>按类加载实例进行统计</td></tr><tr><td style=text-align:right>[t]</td><td>打印所有 ClassLoader 的继承树</td></tr><tr><td style=text-align:right>[a]</td><td>列出所有 ClassLoader 加载的类，请谨慎使用</td></tr><tr><td style=text-align:right>[c:]</td><td>ClassLoader 的 hashcode</td></tr><tr><td style=text-align:right>[classLoaderClass:]</td><td>指定执行表达式的 ClassLoader 的 class name</td></tr><tr><td style=text-align:right>[c: r:]</td><td>用 ClassLoader 去查找 resource</td></tr><tr><td style=text-align:right>[c: load:]</td><td>用 ClassLoader 去加载指定的类</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 按类加载类型查看统计信息</span>
</span></span><span class=line><span class=cl>classloader
</span></span><span class=line><span class=cl><span class=c1># 按类加载实例查看统计信息</span>
</span></span><span class=line><span class=cl>classloader -l
</span></span><span class=line><span class=cl><span class=c1># 查看 ClassLoader 的继承树</span>
</span></span><span class=line><span class=cl>classloader -t
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 URLClassLoader 实际的 urls</span>
</span></span><span class=line><span class=cl>classloader -c 3d4eac69
</span></span><span class=line><span class=cl><span class=c1># 注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。</span>
</span></span><span class=line><span class=cl><span class=c1># 对于只有唯一实例的 ClassLoader 可以通过 class name 指定，使用起来更加方便：</span>
</span></span><span class=line><span class=cl>classloader --classLoaderClass sun.misc.Launcher<span class=nv>$AppClassLoader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用 ClassLoader 去查找 resource</span>
</span></span><span class=line><span class=cl>classloader -c 3d4eac69  -r META-INF/MANIFEST.MF
</span></span><span class=line><span class=cl><span class=c1># 也可以尝试查找类的 class 文件：</span>
</span></span><span class=line><span class=cl>classloader -c 1b6d3586 -r java/lang/String.class
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用 ClassLoader 去加载类</span>
</span></span><span class=line><span class=cl>classloader -c 3d4eac69 --load demo.MathGame
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 统计 ClassLoader 实际使用 URL 和未使用的 URL</span>
</span></span><span class=line><span class=cl>classloader --url-stat
</span></span><span class=line><span class=cl><span class=c1># 注意，基于 JVM 目前已加载的所有类统计，不代表 Unused URLs 可以从应用中删掉。因为可能将来需要从 Unused URLs 里加载类，或者需要加载 resources。</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=增强命令>增强命令</h2><h3 id=monitor>monitor</h3><blockquote><p><strong>提示</strong></p><p>方法执行监控</p></blockquote><p>对匹配 <code>class-pattern</code>／<code>method-pattern</code>／<code>condition-express</code> 的类、方法的调用进行监控。</p><p><code>monitor</code> 命令是一个非实时返回命令.</p><p>实时返回命令是输入之后立即返回，而非实时返回的命令，则是不断的等待目标 Java 进程返回信息，直到用户输入 <code>Ctrl+C</code> 为止。</p><p>服务端是以任务的形式在后台跑任务，植入的代码随着任务的中止而不会被执行，所以任务关闭后，不会对原有性能产生太大影响，而且原则上，任何 Arthas 命令不会引起原有业务逻辑的改变。</p><p>监控维度：</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>监控项</th><th>说明</th></tr></thead><tbody><tr><td style=text-align:right>timestamp</td><td>时间戳</td></tr><tr><td style=text-align:right>class</td><td>Java 类</td></tr><tr><td style=text-align:right>method</td><td>方法（构造方法、普通方法）</td></tr><tr><td style=text-align:right>total</td><td>调用次数</td></tr><tr><td style=text-align:right>success</td><td>成功次数</td></tr><tr><td style=text-align:right>fail</td><td>失败次数</td></tr><tr><td style=text-align:right>rt</td><td>平均 RT</td></tr><tr><td style=text-align:right>fail-rate</td><td>失败率</td></tr></tbody></table></div><p>参数：</p><p>方法拥有一个命名参数 <code>[c:]</code>，意思是统计周期（cycle of output），拥有一个整型的参数值</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>class-pattern</em></td><td>类名表达式匹配</td></tr><tr><td style=text-align:right><em>method-pattern</em></td><td>方法名表达式匹配</td></tr><tr><td style=text-align:right><em>condition-express</em></td><td>条件表达式</td></tr><tr><td style=text-align:right>[E]</td><td>开启正则表达式匹配，默认为通配符匹配</td></tr><tr><td style=text-align:right>[c:]</td><td>统计周期，默认值为 120 秒</td></tr><tr><td style=text-align:right>[b]</td><td>在方法调用之前计算 condition-express</td></tr><tr><td style=text-align:right>[m &lt;arg>]</td><td>指定 Class 最大匹配数量，默认值为 50。长格式为[maxMatch &lt;arg>]。</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ monitor -c <span class=m>5</span> demo.MathGame primeFactors
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>94</span> ms.
</span></span><span class=line><span class=cl> timestamp            class          method        total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>-----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2018-12-03 19:06:38  demo.MathGame  primeFactors  <span class=m>5</span>      <span class=m>1</span>        <span class=m>4</span>     1.15        80.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method        total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>-----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2018-12-03 19:06:43  demo.MathGame  primeFactors  <span class=m>5</span>      <span class=m>3</span>        <span class=m>2</span>     42.29       40.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method        total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>-----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2018-12-03 19:06:48  demo.MathGame  primeFactors  <span class=m>5</span>      <span class=m>3</span>        <span class=m>2</span>     67.92       40.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method        total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>-----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2018-12-03 19:06:53  demo.MathGame  primeFactors  <span class=m>5</span>      <span class=m>2</span>        <span class=m>3</span>     0.25        60.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method        total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>-----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2018-12-03 19:06:58  demo.MathGame  primeFactors  <span class=m>1</span>      <span class=m>1</span>        <span class=m>0</span>     0.45        0.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method        total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>-----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2018-12-03 19:07:03  demo.MathGame  primeFactors  <span class=m>2</span>      <span class=m>2</span>        <span class=m>0</span>     3182.72     0.00%
</span></span></code></pre></td></tr></table></div></div><h4 id=指定-class-最大匹配数量>指定 Class 最大匹配数量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ monitor -c <span class=m>1</span> -m <span class=m>1</span> demo.MathGame primeFactors
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count:1 , method count:1<span class=o>)</span> cost in <span class=m>384</span> ms, listenerId: 6.
</span></span><span class=line><span class=cl> timestamp            class          method        total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>-----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2022-12-25 21:12:58  demo.MathGame  primeFactors  <span class=m>1</span>      <span class=m>1</span>        <span class=m>0</span>     0.18        0.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method        total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>-----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2022-12-25 21:12:59  demo.MathGame  primeFactors  <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span>     0.00       0.00%
</span></span></code></pre></td></tr></table></div></div><h4 id=计算条件表达式过滤统计结果方法执行完毕之后>计算条件表达式过滤统计结果(方法执行完毕之后)</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>monitor -c <span class=m>5</span> demo.MathGame primeFactors <span class=s2>&#34;params[0] &lt;= 2&#34;</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>19</span> ms, listenerId: <span class=m>5</span>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>-----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:42:36  demo.MathGame  primeFactors    <span class=m>5</span>       <span class=m>3</span>       <span class=m>2</span>      0.09       40.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:42:41  demo.MathGame  primeFactors    <span class=m>5</span>       <span class=m>2</span>       <span class=m>3</span>      0.11       60.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:42:46  demo.MathGame  primeFactors    <span class=m>5</span>       <span class=m>1</span>       <span class=m>4</span>      0.06       80.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:42:51  demo.MathGame  primeFactors    <span class=m>5</span>       <span class=m>1</span>       <span class=m>4</span>      0.12       80.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:42:56  demo.MathGame  primeFactors    <span class=m>5</span>       <span class=m>3</span>       <span class=m>2</span>      0.15       40.00%
</span></span></code></pre></td></tr></table></div></div><h4 id=计算条件表达式过滤统计结果方法执行完毕之前>计算条件表达式过滤统计结果(方法执行完毕之前)</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>monitor -b -c <span class=m>5</span> com.test.testes.MathGame primeFactors <span class=s2>&#34;params[0] &lt;= 2&#34;</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>21</span> ms, listenerId: <span class=m>4</span>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:41:57  demo.MathGame  primeFactors    <span class=m>1</span>       <span class=m>0</span>        <span class=m>1</span>      0.10      100.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:42:02  demo.MathGame  primeFactors    <span class=m>3</span>       <span class=m>0</span>        <span class=m>3</span>      0.06      100.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:42:07  demo.MathGame  primeFactors    <span class=m>2</span>       <span class=m>0</span>        <span class=m>2</span>      0.06      100.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:42:12  demo.MathGame  primeFactors    <span class=m>1</span>       <span class=m>0</span>        <span class=m>1</span>      0.05      100.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> timestamp            class          method         total  success  fail  avg-rt<span class=o>(</span>ms<span class=o>)</span>  fail-rate
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> 2020-09-02 09:42:17  demo.MathGame  primeFactors    <span class=m>2</span>       <span class=m>0</span>        <span class=m>2</span>      0.10      100.00%
</span></span></code></pre></td></tr></table></div></div><h3 id=watch>watch</h3><blockquote><p><strong>提示</strong></p><p>函数执行数据观测</p></blockquote><p>让你能方便的观察到指定函数的调用情况。能观察到的范围为：<code>返回值</code>、<code>抛出异常</code>、<code>入参</code>，通过编写 OGNL 表达式进行对应变量的查看。</p><p>watch 的参数比较多，主要是因为它能在 4 个不同的场景观察对象</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>class-pattern</em></td><td>类名表达式匹配</td></tr><tr><td style=text-align:right><em>method-pattern</em></td><td>函数名表达式匹配</td></tr><tr><td style=text-align:right><em>express</em></td><td>观察表达式，默认值：{params, target, returnObj}</td></tr><tr><td style=text-align:right><em>condition-express</em></td><td>条件表达式</td></tr><tr><td style=text-align:right>[b]</td><td>在<strong>函数调用之前</strong>观察</td></tr><tr><td style=text-align:right>[e]</td><td>在<strong>函数异常之后</strong>观察</td></tr><tr><td style=text-align:right>[s]</td><td>在<strong>函数返回之后</strong>观察</td></tr><tr><td style=text-align:right>[f]</td><td>在<strong>函数结束之后</strong>(正常返回和异常返回)观察</td></tr><tr><td style=text-align:right>[E]</td><td>开启正则表达式匹配，默认为通配符匹配</td></tr><tr><td style=text-align:right>[x:]</td><td>指定输出结果的属性遍历深度，默认为 1，最大值是 4</td></tr><tr><td style=text-align:right>[m &lt;arg>]</td><td>指定 Class 最大匹配数量，默认值为 50。长格式为[maxMatch &lt;arg>]。</td></tr></tbody></table></div><p>这里重点要说明的是观察表达式，观察表达式的构成主要由 ognl 表达式组成，所以你可以这样写 <code>"{params,returnObj}"</code>，只要是一个合法的 ognl 表达式，都能被正常支持。</p><p>观察的维度也比较多，主要体现在参数 <code>advice</code> 的数据结构上。<code>Advice</code> 参数最主要是封装了通知节点的所有信息。请参考<a class=link href=#%e8%a1%a8%e8%be%be%e5%bc%8f%e6%a0%b8%e5%bf%83%e5%8f%98%e9%87%8f>表达式核心变量</a>中关于该节点的描述。</p><ul><li>watch 命令定义了 4 个观察事件点，即 <code>-b</code> 函数调用前，<code>-e</code> 函数异常后，<code>-s</code> 函数返回后，<code>-f</code> 函数结束后</li><li>4 个观察事件点 <code>-b</code>、<code>-e</code>、<code>-s</code> 默认关闭，<code>-f</code> 默认打开，当指定观察点被打开后，在相应事件点会对观察表达式进行求值并输出</li><li>这里要注意 <code>函数入参</code> 和 <code>函数出参</code> 的区别，有可能在中间被修改导致前后不一致，除了 <code>-b</code> 事件点 <code>params</code> 代表函数入参外，其余事件都代表函数出参</li><li>当使用 -b 时，由于观察事件点是在函数调用前，此时返回值或异常均不存在</li><li>在 watch 命令的结果里，会打印出 <code>location</code> 信息。<code>location</code> 有三种可能值：<code>AtEnter</code>，<code>AtExit</code>，<code>AtExceptionExit</code>。对应函数入口，函数正常 return，函数抛出异常。</li></ul><h4 id=观察函数调用返回时的参数this-对象和返回值>观察函数调用返回时的参数、this 对象和返回值</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 观察表达式，默认值是{params, target, returnObj}</span>
</span></span><span class=line><span class=cl>$ watch demo.MathGame primeFactors -x <span class=m>2</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>32</span> ms, listenerId: <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=nv>method</span><span class=o>=</span>demo.MathGame.primeFactors <span class=nv>location</span><span class=o>=</span>AtExceptionExit
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2021-08-31 15:22:57<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.220625ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>-179173<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    @MathGame<span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=nv>random</span><span class=o>=</span>@Random<span class=o>[</span>java.util.Random@31cefde0<span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=nv>illegalArgumentCount</span><span class=o>=</span>@Integer<span class=o>[</span>44<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    null,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>method</span><span class=o>=</span>demo.MathGame.primeFactors <span class=nv>location</span><span class=o>=</span>AtExit
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2021-08-31 15:22:58<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>1.020982ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>1<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    @MathGame<span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=nv>random</span><span class=o>=</span>@Random<span class=o>[</span>java.util.Random@31cefde0<span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=nv>illegalArgumentCount</span><span class=o>=</span>@Integer<span class=o>[</span>44<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    @ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>2<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>2<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>26947<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>上面的结果里，说明函数被执行了两次，第一次结果是 <code>location=AtExceptionExit</code>，说明函数抛出异常了，因此 <code>returnObj</code> 是 null</li><li>在第二次结果里是 <code>location=AtExit</code>，说明函数正常返回，因此可以看到 <code>returnObj</code> 结果是一个 ArrayList</li></ul><h4 id=指定-class-最大匹配数量-1>指定 Class 最大匹配数量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors -m <span class=m>1</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>302</span> ms, listenerId: <span class=m>3</span>
</span></span><span class=line><span class=cl><span class=nv>method</span><span class=o>=</span>demo.MathGame.primeFactors <span class=nv>location</span><span class=o>=</span>AtExceptionExit
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2022-12-25 19:58:41<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.222419ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span><span class=nv>isEmpty</span><span class=o>=</span>false<span class=p>;</span><span class=nv>size</span><span class=o>=</span>1<span class=o>]</span>,
</span></span><span class=line><span class=cl>    @MathGame<span class=o>[</span>demo.MathGame@3bf400<span class=o>]</span>,
</span></span><span class=line><span class=cl>    null,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>method</span><span class=o>=</span>demo.MathGame.primeFactors <span class=nv>location</span><span class=o>=</span>AtExceptionExit
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2022-12-25 19:58:51<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.046928ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span><span class=nv>isEmpty</span><span class=o>=</span>false<span class=p>;</span><span class=nv>size</span><span class=o>=</span>1<span class=o>]</span>,
</span></span><span class=line><span class=cl>    @MathGame<span class=o>[</span>demo.MathGame@3bf400<span class=o>]</span>,
</span></span><span class=line><span class=cl>    null,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=观察函数调用入口的参数和返回值>观察函数调用入口的参数和返回值</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors <span class=s2>&#34;{params,returnObj}&#34;</span> -x <span class=m>2</span> -b
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>50</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 19:23:23<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.0353ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>-1077465243<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    null,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># 对比前一个例子，返回值为空（事件点为函数执行前，因此获取不到返回值）</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=同时观察函数调用前和函数返回后>同时观察函数调用前和函数返回后</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors <span class=s2>&#34;{params,target,returnObj}&#34;</span> -x <span class=m>2</span> -b -s -n <span class=m>2</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>46</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 19:29:54<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.01696ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>1<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    @MathGame<span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=nv>random</span><span class=o>=</span>@Random<span class=o>[</span>java.util.Random@522b408a<span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=nv>illegalArgumentCount</span><span class=o>=</span>@Integer<span class=o>[</span>13038<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    null,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 19:29:54<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>4.277392ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>1<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    @MathGame<span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=nv>random</span><span class=o>=</span>@Random<span class=o>[</span>java.util.Random@522b408a<span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=nv>illegalArgumentCount</span><span class=o>=</span>@Integer<span class=o>[</span>13038<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    @ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>2<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>2<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>2<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>5<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>5<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>73<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>241<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>439<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>参数里 <code>-n 2</code>，表示只执行两次</li><li>这里输出结果中，第一次输出的是函数调用前的观察表达式的结果，第二次输出的是函数返回后的表达式的结果</li><li>结果的输出顺序和事件发生的先后顺序一致，和命令中 <code>-s</code> <code>-b</code> 的顺序无关</li></ul><h4 id=调整-x-的值观察具体的函数参数值>调整-x 的值，观察具体的函数参数值</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors <span class=s2>&#34;{params,target}&#34;</span> -x <span class=m>3</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>58</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 19:34:19<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.587833ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>1<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    @MathGame<span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=nv>random</span><span class=o>=</span>@Random<span class=o>[</span>
</span></span><span class=line><span class=cl>            <span class=nv>serialVersionUID</span><span class=o>=</span>@Long<span class=o>[</span>3905348978240129619<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>seed</span><span class=o>=</span>@AtomicLong<span class=o>[</span>3133719055989<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>multiplier</span><span class=o>=</span>@Long<span class=o>[</span>25214903917<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>addend</span><span class=o>=</span>@Long<span class=o>[</span>11<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>mask</span><span class=o>=</span>@Long<span class=o>[</span>281474976710655<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>DOUBLE_UNIT</span><span class=o>=</span>@Double<span class=o>[</span>1.1102230246251565E-16<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>BadBound</span><span class=o>=</span>@String<span class=o>[</span>bound must be positive<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>BadRange</span><span class=o>=</span>@String<span class=o>[</span>bound must be greater than origin<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>BadSize</span><span class=o>=</span>@String<span class=o>[</span>size must be non-negative<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>seedUniquifier</span><span class=o>=</span>@AtomicLong<span class=o>[</span>-3282039941672302964<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>nextNextGaussian</span><span class=o>=</span>@Double<span class=o>[</span>0.0<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>haveNextNextGaussian</span><span class=o>=</span>@Boolean<span class=o>[</span>false<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>serialPersistentFields</span><span class=o>=</span>@ObjectStreamField<span class=o>[][</span><span class=nv>isEmpty</span><span class=o>=</span>false<span class=p>;</span><span class=nv>size</span><span class=o>=</span>3<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>unsafe</span><span class=o>=</span>@Unsafe<span class=o>[</span>sun.misc.Unsafe@2eaa1027<span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=nv>seedOffset</span><span class=o>=</span>@Long<span class=o>[</span>24<span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=nv>illegalArgumentCount</span><span class=o>=</span>@Integer<span class=o>[</span>13159<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>-x</code> 表示遍历深度，可以调整来打印具体的参数和结果内容，默认值是 1。</li><li><code>-x</code> 最大值是 4，防止展开结果占用太多内存。用户可以在 <code>ognl</code> 表达式里指定更具体的 field。</li></ul><h4 id=条件表达式的例子>条件表达式的例子</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors <span class=s2>&#34;{params[0],target}&#34;</span> <span class=s2>&#34;params[0]&lt;0&#34;</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>68</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 19:36:04<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.530255ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Integer<span class=o>[</span>-18178089<span class=o>]</span>,
</span></span><span class=line><span class=cl>    @MathGame<span class=o>[</span>demo.MathGame@41cf53f9<span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># 只有满足条件的调用，才会有响应。</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=观察异常信息的例子>观察异常信息的例子</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors <span class=s2>&#34;{params[0],throwExp}&#34;</span> -e -x <span class=m>2</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>62</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 19:38:00<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>1.414993ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Integer<span class=o>[</span>-1120397038<span class=o>]</span>,
</span></span><span class=line><span class=cl>    java.lang.IllegalArgumentException: number is: -1120397038, need &gt;<span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>	at demo.MathGame.primeFactors<span class=o>(</span>MathGame.java:46<span class=o>)</span>
</span></span><span class=line><span class=cl>	at demo.MathGame.run<span class=o>(</span>MathGame.java:24<span class=o>)</span>
</span></span><span class=line><span class=cl>	at demo.MathGame.main<span class=o>(</span>MathGame.java:16<span class=o>)</span>
</span></span><span class=line><span class=cl>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>-e</code>表示抛出异常时才触发</li><li>express 中，表示异常信息的变量是 <code>throwExp</code></li></ul><h4 id=按照耗时进行过滤>按照耗时进行过滤</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors <span class=s1>&#39;{params, returnObj}&#39;</span> <span class=s1>&#39;#cost&gt;200&#39;</span> -x <span class=m>2</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>66</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 19:40:28<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>2112.168897ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>1<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    @ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>5<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>428379493<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>#cost>200</code> (单位是 ms)表示只有当耗时大于 200ms 时才会输出，过滤掉执行时间小于 200ms 的调用</li></ul><h4 id=观察当前对象中的属性>观察当前对象中的属性</h4><p>如果想查看函数运行前后，当前对象中的属性，可以使用 target 关键字，代表当前对象</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors <span class=s1>&#39;target&#39;</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>52</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 19:41:52<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.477882ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@MathGame<span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=nv>random</span><span class=o>=</span>@Random<span class=o>[</span>java.util.Random@522b408a<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=nv>illegalArgumentCount</span><span class=o>=</span>@Integer<span class=o>[</span>13355<span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>然后使用 target.field_name 访问当前对象的某个属性</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch demo.MathGame primeFactors <span class=s1>&#39;target.illegalArgumentCount&#39;</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>67</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 20:04:34<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>131.303498ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@Integer<span class=o>[</span>8<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-03 20:04:35<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.961441ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@Integer<span class=o>[</span>8<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=获取类的静态字段调用类的静态函数的例子>获取类的静态字段、调用类的静态函数的例子</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>watch demo.MathGame * <span class=s1>&#39;{params,@demo.MathGame@random.nextInt(100)}&#39;</span> -v -n <span class=m>1</span> -x <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=o>[</span>arthas@6527<span class=o>]</span>$ watch demo.MathGame * <span class=s1>&#39;{params,@demo.MathGame@random.nextInt(100)}&#39;</span> -n <span class=m>1</span> -x <span class=m>2</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 5<span class=o>)</span> cost in <span class=m>34</span> ms, listenerId: <span class=m>3</span>
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2021-01-05 21:35:20<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.173966ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>    @Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>-138282<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    @Integer<span class=o>[</span>89<span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>注意这里使用 <code>Thread.currentThread().getContextClassLoader()</code> 加载,使用精确 <code>classloader</code> ognl 更好。</p><h4 id=排除掉指定的类>排除掉指定的类</h4><blockquote><p><strong>提示</strong></p><p>watch/trace/monitor/stack/tt 命令都支持 <code>--exclude-class-pattern</code> 参数</p></blockquote><p>使用 <code>--exclude-class-pattern</code> 参数可以排除掉指定的类，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>watch javax.servlet.Filter * --exclude-class-pattern com.demo.TestFilter
</span></span></code></pre></td></tr></table></div></div><h4 id=不匹配子类>不匹配子类</h4><p>默认情况下 watch/trace/monitor/stack/tt 命令都会匹配子类。如果想不匹配，可以通过全局参数关掉。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>options disable-sub-class <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=使用--v-参数打印更多信息>使用 -v 参数打印更多信息</h4><blockquote><p><strong>提示</strong></p><p>watch/trace/monitor/stack/tt 命令都支持 <code>-v</code> 参数</p></blockquote><p>当命令执行之后，没有输出结果。有两种可能：</p><ol><li>匹配到的函数没有被执行</li><li>条件表达式结果是 false</li></ol><p>但用户区分不出是哪种情况。</p><p>使用 -v 选项，则会打印 Condition express 的具体值和执行结果，方便确认。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ watch -v -x <span class=m>2</span> demo.MathGame print <span class=s1>&#39;params&#39;</span> <span class=s1>&#39;params[0] &gt; 100000&#39;</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>29</span> ms, listenerId: <span class=m>11</span>
</span></span><span class=line><span class=cl>Condition express: params<span class=o>[</span>0<span class=o>]</span> &gt; <span class=m>100000</span> , result: <span class=nb>false</span>
</span></span><span class=line><span class=cl>Condition express: params<span class=o>[</span>0<span class=o>]</span> &gt; <span class=m>100000</span> , result: <span class=nb>false</span>
</span></span><span class=line><span class=cl>Condition express: params<span class=o>[</span>0<span class=o>]</span> &gt; <span class=m>100000</span> , result: <span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2020-12-02 22:38:56<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.060843ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>    @Integer<span class=o>[</span>200033<span class=o>]</span>,
</span></span><span class=line><span class=cl>    @ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>200033<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl>Condition express: params<span class=o>[</span>0<span class=o>]</span> &gt; <span class=m>100000</span> , result: <span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2020-12-02 22:38:57<span class=p>;</span> <span class=o>[</span><span class=nv>cost</span><span class=o>=</span>0.052877ms<span class=o>]</span> <span class=nv>result</span><span class=o>=</span>@Object<span class=o>[][</span>
</span></span><span class=line><span class=cl>    @Integer<span class=o>[</span>123047<span class=o>]</span>,
</span></span><span class=line><span class=cl>    @ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>29<span class=o>]</span>,
</span></span><span class=line><span class=cl>        @Integer<span class=o>[</span>4243<span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=trace>trace</h3><blockquote><p><strong>提示</strong></p><p>方法内部调用路径，并输出方法路径上的每个节点上耗时</p></blockquote><p><code>trace</code> 命令能主动搜索 <code>class-pattern</code>／<code>method-pattern</code> 对应的方法调用路径，渲染和统计整个调用链路上的所有性能开销和追踪调用链路。</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>class-pattern</em></td><td>类名表达式匹配</td></tr><tr><td style=text-align:right><em>method-pattern</em></td><td>方法名表达式匹配</td></tr><tr><td style=text-align:right><em>condition-express</em></td><td>条件表达式</td></tr><tr><td style=text-align:right>[E]</td><td>开启正则表达式匹配，默认为通配符匹配</td></tr><tr><td style=text-align:right>[n:]</td><td>命令执行次数</td></tr><tr><td style=text-align:right>#cost</td><td>方法执行耗时</td></tr><tr><td style=text-align:right>[m &lt;arg>]</td><td>指定 Class 最大匹配数量，默认值为 50。长格式为[maxMatch &lt;arg>]。</td></tr></tbody></table></div><p>这里重点要说明的是条件表达式，条件表达式的构成主要由 <code>ognl</code> 表达式组成，所以你可以这样写 <code>"params[0]&lt;0"</code>，只要是一个合法的 ognl 表达式，都能被正常支持。</p><p>很多时候我们只想看到某个方法的 rt 大于某个时间之后的 trace 结果，现在 Arthas 可以按照方法执行的耗时来进行过滤了，例如 <code>trace \*StringUtils isBlank '#cost>100'</code> 表示当执行时间超过 100ms 的时候，才会输出 trace 的结果。</p><blockquote><p><strong>提示</strong></p><p>watch/stack/trace 这个三个命令都支持 <code>#cost</code></p></blockquote><p>注意事项:</p><ul><li>trace 能方便的帮助你定位和发现因 RT 高而导致的性能问题缺陷，但其每次只能跟踪一级方法的调用链路。</li><li>3.3.0 版本后，可以使用动态 Trace 功能，不断增加新的匹配类，参考下面的示例。</li><li>目前不支持 trace java.lang.Thread getName ，考虑到不是非常必要场景，且修复有一定难度，因此当前暂不修复</li></ul><h4 id=trace-函数>trace 函数</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ trace demo.MathGame run
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>28</span> ms.
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2019-12-04 00:45:08<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>0.617465ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>0.078946ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span> <span class=c1>#24 [throws Exception]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2019-12-04 00:45:09<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>1.276874ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>0.03752ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span> <span class=c1>#24 [throws Exception]</span>
</span></span></code></pre></td></tr></table></div></div><p>结果里的 <code>#24</code>，表示在 run 函数里，在源文件的第 24 行调用了<code>primeFactors()</code>函数。</p><h4 id=指定-class-匹配的最大数量>指定 Class 匹配的最大数量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ trace demo.MathGame run -m <span class=m>1</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>412</span> ms, listenerId: <span class=m>4</span>
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2022-12-25 21:00:00<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@b4aac2
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>0.762093ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>30.21% 0.230241ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span> <span class=c1>#46 [throws Exception]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2022-12-25 21:00:10<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@b4aac2
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>0.315298ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>13.95% 0.043995ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span> <span class=c1>#46 [throws Exception]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=trace-次数限制>trace 次数限制</h4><p>如果方法调用的次数很多，那么可以用 <code>-n</code> 参数指定捕捉结果的次数。比如下面的例子里，捕捉到一次调用就退出命令。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>trace demo.MathGame run -n <span class=m>1</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>20</span> ms.
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2019-12-04 00:45:53<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>0.549379ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.059839ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span> <span class=c1>#24</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>0.232887ms<span class=o>]</span> demo.MathGame:print<span class=o>()</span> <span class=c1>#25</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Command execution <span class=nb>times</span> exceed limit: 1, so <span class=nb>command</span> will exit. You can <span class=nb>set</span> it with -n option.
</span></span></code></pre></td></tr></table></div></div><h4 id=包含-jdk-的函数>包含 jdk 的函数</h4><ul><li><code>--skipJDKMethod &lt;value></code> skip jdk method trace, default value true.</li></ul><p>默认情况下，trace 不会包含 jdk 里的函数调用，如果希望 trace jdk 里的函数，需要显式设置 <code>--skipJDKMethod false</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ trace --skipJDKMethod <span class=nb>false</span> demo.MathGame run
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>60</span> ms.
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2019-12-04 00:44:41<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>1.357742ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.028624ms<span class=o>]</span> java.util.Random:nextInt<span class=o>()</span> <span class=c1>#23</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.045534ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span> <span class=c1>#24 [throws Exception]</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.005372ms<span class=o>]</span> java.lang.StringBuilder:&lt;init&gt;<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.012257ms<span class=o>]</span> java.lang.Integer:valueOf<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.234537ms<span class=o>]</span> java.lang.String:format<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span><span class=nv>min</span><span class=o>=</span>0.004539ms,max<span class=o>=</span>0.005778ms,total<span class=o>=</span>0.010317ms,count<span class=o>=</span>2<span class=o>]</span> java.lang.StringBuilder:append<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.013777ms<span class=o>]</span> java.lang.Exception:getMessage<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.004935ms<span class=o>]</span> java.lang.StringBuilder:toString<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>0.06941ms<span class=o>]</span> java.io.PrintStream:println<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2019-12-04 00:44:42<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>3.030432ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.010473ms<span class=o>]</span> java.util.Random:nextInt<span class=o>()</span> <span class=c1>#23</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.023715ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span> <span class=c1>#24 [throws Exception]</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.005198ms<span class=o>]</span> java.lang.StringBuilder:&lt;init&gt;<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.006405ms<span class=o>]</span> java.lang.Integer:valueOf<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.178583ms<span class=o>]</span> java.lang.String:format<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span><span class=nv>min</span><span class=o>=</span>0.011636ms,max<span class=o>=</span>0.838077ms,total<span class=o>=</span>0.849713ms,count<span class=o>=</span>2<span class=o>]</span> java.lang.StringBuilder:append<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.008747ms<span class=o>]</span> java.lang.Exception:getMessage<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.019768ms<span class=o>]</span> java.lang.StringBuilder:toString<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>0.076457ms<span class=o>]</span> java.io.PrintStream:println<span class=o>()</span> <span class=c1>#28</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=根据调用耗时过滤>根据调用耗时过滤</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ trace demo.MathGame run <span class=s1>&#39;#cost &gt; 10&#39;</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>41</span> ms.
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2018-12-04 01:12:02<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>12.033735ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.006783ms<span class=o>]</span> java.util.Random:nextInt<span class=o>()</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>11.852594ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>0.05447ms<span class=o>]</span> demo.MathGame:print<span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>只会展示耗时大于 10ms 的调用路径，有助于在排查问题的时候，只关注异常情况</p></blockquote><ul><li>是不是很眼熟，没错，在 JProfiler 等收费软件中你曾经见识类似的功能，这里你将可以通过命令就能打印出指定调用路径。 友情提醒下，<code>trace</code> 在执行的过程中本身是会有一定的性能开销，在统计的报告中并未像 JProfiler 一样预先减去其自身的统计开销。所以这统计出来有些许的不准，渲染路径上调用的类、方法越多，性能偏差越大。但还是能让你看清一些事情的。</li><li>[12.033735ms] 的含义，<code>12.033735</code> 的含义是：当前节点在当前步骤的耗时，单位为毫秒</li><li>[0,0,0ms,11]xxx:yyy() [throws Exception]，对该方法中相同的方法调用进行了合并，<code>0,0,0ms,11</code> 表示方法调用耗时，<code>min,max,total,count</code>；<code>throws Exception</code> 表明该方法调用中存在异常返回</li><li>这里存在一个统计不准确的问题，就是所有方法耗时加起来可能会小于该监测方法的总耗时，这个是由于 Arthas 本身的逻辑会有一定的耗时</li></ul><h4 id=trace-多个类或者多个函数>trace 多个类或者多个函数</h4><p>trace 命令只会 trace 匹配到的函数里的子调用，并不会向下 trace 多层。因为 trace 是代价比较贵的，多层 trace 可能会导致最终要 trace 的类和函数非常多。</p><p>可以用正则表匹配路径上的多个类和函数，一定程度上达到多层 trace 的效果。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>trace -E com.test.ClassA<span class=p>|</span>org.test.ClassB method1<span class=p>|</span>method2<span class=p>|</span>method3
</span></span></code></pre></td></tr></table></div></div><h4 id=trace-时间不准确>trace 时间不准确</h4><p>比如下面的结果里：<code>0.705196</code> > <code>(0.152743 + 0.145825)</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ trace demo.MathGame run -n <span class=m>1</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>66</span> ms, listenerId: <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2021-02-08 11:27:36<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@232204a1
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>0.705196ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.152743ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span> <span class=c1>#24</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>0.145825ms<span class=o>]</span> demo.MathGame:print<span class=o>()</span> <span class=c1>#25</span>
</span></span></code></pre></td></tr></table></div></div><p>那么其它的时间消耗在哪些地方？</p><ol><li>没有被 trace 到的函数。比如 <code>java.\*</code> 下的函数调用默认会忽略掉。通过增加 <code>--skipJDKMethod false</code> 参数可以打印出来。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ trace demo.MathGame run --skipJDKMethod <span class=nb>false</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>35</span> ms, listenerId: <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=sb>`</span>---ts<span class=o>=</span>2021-02-08 11:27:48<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@232204a1
</span></span><span class=line><span class=cl>    <span class=sb>`</span>---<span class=o>[</span>0.810591ms<span class=o>]</span> demo.MathGame:run<span class=o>()</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.034568ms<span class=o>]</span> java.util.Random:nextInt<span class=o>()</span> <span class=c1>#23</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.119367ms<span class=o>]</span> demo.MathGame:primeFactors<span class=o>()</span> <span class=c1>#24 [throws Exception]</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.017407ms<span class=o>]</span> java.lang.StringBuilder:&lt;init&gt;<span class=o>()</span> <span class=c1>#28</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.127922ms<span class=o>]</span> java.lang.String:format<span class=o>()</span> <span class=c1>#57</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span><span class=nv>min</span><span class=o>=</span>0.01419ms,max<span class=o>=</span>0.020221ms,total<span class=o>=</span>0.034411ms,count<span class=o>=</span>2<span class=o>]</span> java.lang.StringBuilder:append<span class=o>()</span> <span class=c1>#57</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.021911ms<span class=o>]</span> java.lang.Exception:getMessage<span class=o>()</span> <span class=c1>#57</span>
</span></span><span class=line><span class=cl>        +---<span class=o>[</span>0.015643ms<span class=o>]</span> java.lang.StringBuilder:toString<span class=o>()</span> <span class=c1>#57</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>---<span class=o>[</span>0.086622ms<span class=o>]</span> java.io.PrintStream:println<span class=o>()</span> <span class=c1>#57</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>非函数调用的指令消耗。比如 i++, getfield 等指令。</li><li>在代码执行过程中，JVM 可能出现停顿，比如 GC，进入同步块等。</li></ol><h3 id=stack>stack</h3><blockquote><p><strong>提示</strong></p><p>输出当前方法被调用的调用路径</p></blockquote><p>很多时候我们都知道一个方法被执行，但这个方法被执行的路径非常多，或者你根本就不知道这个方法是从那里被执行了，此时你需要的是 stack 命令。</p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>class-pattern</em></td><td>类名表达式匹配</td></tr><tr><td style=text-align:right><em>method-pattern</em></td><td>方法名表达式匹配</td></tr><tr><td style=text-align:right><em>condition-express</em></td><td>条件表达式</td></tr><tr><td style=text-align:right>[E]</td><td>开启正则表达式匹配，默认为通配符匹配</td></tr><tr><td style=text-align:right>[n:]</td><td>执行次数限制</td></tr><tr><td style=text-align:right>[m &lt;arg>]</td><td>指定 Class 最大匹配数量，默认值为 50。长格式为[maxMatch &lt;arg>]。</td></tr></tbody></table></div><p>这里重点要说明的是观察表达式，观察表达式的构成主要由 <code>ognl</code> 表达式组成，所以你可以这样写 <code>"{params,returnObj}"</code>，只要是一个合法的 ognl 表达式，都能被正常支持。</p><p>观察的维度也比较多，主要体现在参数 <code>advice</code> 的数据结构上。<code>Advice</code> 参数最主要是封装了通知节点的所有信息。</p><h4 id=stack---run>stack - run</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ stack demo.MathGame primeFactors
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>36</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-04 01:32:19<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    @demo.MathGame.run<span class=o>()</span>
</span></span><span class=line><span class=cl>        at demo.MathGame.main<span class=o>(</span>MathGame.java:16<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=指定-class-最大匹配数量-2>指定 Class 最大匹配数量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ stack demo.MathGame primeFactors -m <span class=m>1</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count:1 , method count:1<span class=o>)</span> cost in <span class=m>561</span> ms, listenerId: 5.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2022-12-25 21:07:07<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@b4aac2
</span></span><span class=line><span class=cl>    @demo.MathGame.primeFactors<span class=o>()</span>
</span></span><span class=line><span class=cl>        at demo.MathGame.run<span class=o>(</span>MathGame.java:46<span class=o>)</span>
</span></span><span class=line><span class=cl>        at demo.MathGame.main<span class=o>(</span>MathGame.java:38<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=据条件表达式来过滤>据条件表达式来过滤</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ stack demo.MathGame primeFactors <span class=s1>&#39;params[0]&lt;0&#39;</span> -n <span class=m>2</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>30</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-04 01:34:27<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    @demo.MathGame.run<span class=o>()</span>
</span></span><span class=line><span class=cl>        at demo.MathGame.main<span class=o>(</span>MathGame.java:16<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-04 01:34:30<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    @demo.MathGame.run<span class=o>()</span>
</span></span><span class=line><span class=cl>        at demo.MathGame.main<span class=o>(</span>MathGame.java:16<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Command execution <span class=nb>times</span> exceed limit: 2, so <span class=nb>command</span> will exit. You can <span class=nb>set</span> it with -n option.
</span></span></code></pre></td></tr></table></div></div><h4 id=据执行时间来过滤>据执行时间来过滤</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ stack demo.MathGame primeFactors <span class=s1>&#39;#cost&gt;5&#39;</span>
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>35</span> ms.
</span></span><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2018-12-04 01:35:58<span class=p>;</span><span class=nv>thread_name</span><span class=o>=</span>main<span class=p>;</span><span class=nv>id</span><span class=o>=</span>1<span class=p>;</span><span class=nv>is_daemon</span><span class=o>=</span>false<span class=p>;</span><span class=nv>priority</span><span class=o>=</span>5<span class=p>;</span><span class=nv>TCCL</span><span class=o>=</span>sun.misc.Launcher<span class=nv>$AppClassLoader</span>@3d4eac69
</span></span><span class=line><span class=cl>    @demo.MathGame.run<span class=o>()</span>
</span></span><span class=line><span class=cl>        at demo.MathGame.main<span class=o>(</span>MathGame.java:16<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=tt>tt</h3><blockquote><p><strong>提示</strong></p><p>方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</p></blockquote><p><code>watch</code> 虽然很方便和灵活，但需要提前想清楚观察表达式的拼写，这对排查问题而言要求太高，因为很多时候我们并不清楚问题出自于何方，只能靠蛛丝马迹进行猜测。</p><p>这个时候如果能记录下当时方法调用的所有入参和返回值、抛出的异常会对整个问题的思考与判断非常有帮助。</p><p>于是乎，TimeTunnel 命令就诞生了。</p><p>注意事项:</p><ul><li>tt 命令的实现是：把函数的入参/返回值等，保存到一个 <code>Map&lt;Integer, TimeFragment></code> 里，默认的大小是 100。</li><li>tt 相关功能在使用完之后，需要手动释放内存，否则长时间可能导致 OOM。退出 arthas 不会自动清除 tt 的缓存 map。</li></ul><h4 id=记录调用>记录调用</h4><p>对于一个最基本的使用来说，就是记录下当前方法的每次调用环境现场。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tt -t demo.MathGame primeFactors
</span></span><span class=line><span class=cl>Press Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class-cnt:1 , method-cnt:1<span class=o>)</span> cost in <span class=m>66</span> ms.
</span></span><span class=line><span class=cl> INDEX   TIMESTAMP            COST<span class=o>(</span>ms<span class=o>)</span>  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> <span class=m>1000</span>    2018-12-04 11:15:38  1.096236  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1001</span>    2018-12-04 11:15:39  0.191848  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1002</span>    2018-12-04 11:15:40  0.069523  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1003</span>    2018-12-04 11:15:41  0.186073  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1004</span>    2018-12-04 11:15:42  17.76437  <span class=nb>true</span>    <span class=nb>false</span>    0x4b67cf4d     MathGame
</span></span></code></pre></td></tr></table></div></div><h4 id=指定-class-最大匹配数量-3>指定 Class 最大匹配数量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tt -t -m <span class=m>1</span> demo.MathGame primeFactors
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count:1 , method count:1<span class=o>)</span> cost in <span class=m>130</span> ms, listenerId: 1.
</span></span><span class=line><span class=cl> INDEX   TIMESTAMP            COST<span class=o>(</span>ms<span class=o>)</span>  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> <span class=m>1000</span>    2022-12-25 19:41:45  2.629929  <span class=nb>true</span>    <span class=nb>false</span>    0x3bf400       MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1001</span>    2022-12-25 19:41:55  0.146161  <span class=nb>false</span>   <span class=nb>true</span>     0x3bf400       MathGame
</span></span></code></pre></td></tr></table></div></div><ul><li><p>命令参数解析</p><ul><li><p><code>-t</code>
<code>tt</code> 命令有很多个主参数，<code>-t</code> 就是其中之一。这个参数的表明希望记录下类 *Test 的 print 方法的每次执行情况。</p></li><li><p><code>-n 3</code>
当你执行一个调用量不高的方法时可能你还能有足够的时间用 <code>CTRL+C</code> 中断 tt 命令记录的过程，但如果遇到调用量非常大的方法，瞬间就能将你的 JVM 内存撑爆。</p><p>此时你可以通过 <code>-n</code> 参数指定你需要记录的次数，当达到记录次数时 Arthas 会主动中断 tt 命令的记录过程，避免人工操作无法停止的情况。</p><ul><li><code>-m 1</code>
通过 <code>-m</code> 参数指定 Class 匹配的最大数量，防止匹配到的 Class 数量太多导致 JVM 挂起，默认值是 50</li></ul></li></ul></li><li><p>表格字段说明</p><div class=table-wrapper><table><thead><tr><th>表格字段</th><th>字段解释</th></tr></thead><tbody><tr><td>INDEX</td><td>时间片段记录编号，每一个编号代表着一次调用，后续 tt 还有很多命令都是基于此编号指定记录操作，非常重要。</td></tr><tr><td>TIMESTAMP</td><td>方法执行的本机时间，记录了这个时间片段所发生的本机时间</td></tr><tr><td>COST(ms)</td><td>方法执行的耗时</td></tr><tr><td>IS-RET</td><td>方法是否以正常返回的形式结束</td></tr><tr><td>IS-EXP</td><td>方法是否以抛异常的形式结束</td></tr><tr><td>OBJECT</td><td>执行对象的 hashCode()，注意，曾经有人误认为是对象在 JVM 中的内存地址，但很遗憾他不是。但他能帮助你简单的标记当前执行方法的类实体</td></tr><tr><td>CLASS</td><td>执行的类名</td></tr><tr><td>METHOD</td><td>执行的方法名</td></tr></tbody></table></div></li><li><p>条件表达式
不知道大家是否有在使用过程中遇到以下困惑</p><ul><li>Arthas 似乎很难区分出重载的方法</li><li>我只需要观察特定参数，但是 tt 却全部都给我记录了下来</li></ul><p>条件表达式也是用 OGNL 来编写，核心的判断对象依然是 Advice 对象。除了 tt 命令之外，watch、trace、stack 命令也都支持条件表达式。</p></li><li><p>解决方法重载</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>  tt -t *Test print params.length<span class=o>==</span><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>通过制定参数个数的形式解决不同的方法签名，如果参数个数一样，你还可以这样写</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>tt -t *Test print <span class=s1>&#39;params[1] instanceof Integer&#39;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>解决指定参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>tt -t *Test print params<span class=o>[</span>0<span class=o>]</span>.mobile<span class=o>==</span><span class=s2>&#34;13989838402&#34;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>构成条件表达式的 <code>Advice</code> 对象</p><p>前边看到了很多条件表达式中，都使用了 params[0]，有关这个变量的介绍，请参考表达式核心变量</p></li></ul><h4 id=检索调用记录>检索调用记录</h4><p>当你用 tt 记录了一大片的时间片段之后，你希望能从中筛选出自己需要的时间片段，这个时候你就需要对现有记录进行检索。</p><p>假设我们有这些记录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tt -l
</span></span><span class=line><span class=cl> INDEX   TIMESTAMP            COST<span class=o>(</span>ms<span class=o>)</span>  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> <span class=m>1000</span>    2018-12-04 11:15:38  1.096236  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1001</span>    2018-12-04 11:15:39  0.191848  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1002</span>    2018-12-04 11:15:40  0.069523  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1003</span>    2018-12-04 11:15:41  0.186073  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1004</span>    2018-12-04 11:15:42  17.76437  <span class=nb>true</span>    <span class=nb>false</span>    0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl>                              <span class=m>9</span>
</span></span><span class=line><span class=cl> <span class=m>1005</span>    2018-12-04 11:15:43  0.4776    <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>row-cnt:6<span class=o>)</span> cost in <span class=m>4</span> ms.
</span></span></code></pre></td></tr></table></div></div><p>我需要筛选出 <code>primeFactors</code> 方法的调用信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tt -s <span class=s1>&#39;method.name==&#34;primeFactors&#34;&#39;</span>
</span></span><span class=line><span class=cl> INDEX   TIMESTAMP            COST<span class=o>(</span>ms<span class=o>)</span>  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl> <span class=m>1000</span>    2018-12-04 11:15:38  1.096236  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1001</span>    2018-12-04 11:15:39  0.191848  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1002</span>    2018-12-04 11:15:40  0.069523  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1003</span>    2018-12-04 11:15:41  0.186073  <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl> <span class=m>1004</span>    2018-12-04 11:15:42  17.76437  <span class=nb>true</span>    <span class=nb>false</span>    0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl>                              <span class=m>9</span>
</span></span><span class=line><span class=cl> <span class=m>1005</span>    2018-12-04 11:15:43  0.4776    <span class=nb>false</span>   <span class=nb>true</span>     0x4b67cf4d     MathGame                       primeFactors
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>row-cnt:6<span class=o>)</span> cost in <span class=m>607</span> ms.
</span></span></code></pre></td></tr></table></div></div><p>你需要一个 <code>-s</code> 参数。同样的，搜索表达式的核心对象依旧是 Advice 对象。</p><h4 id=查看调用信息>查看调用信息</h4><p>对于具体一个时间片的信息而言，你可以通过 <code>-i</code> 参数后边跟着对应的 <code>INDEX</code> 编号查看到他的详细信息。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tt -i <span class=m>1003</span>
</span></span><span class=line><span class=cl> INDEX            <span class=m>1003</span>
</span></span><span class=line><span class=cl> GMT-CREATE       2018-12-04 11:15:41
</span></span><span class=line><span class=cl> COST<span class=o>(</span>ms<span class=o>)</span>         0.186073
</span></span><span class=line><span class=cl> OBJECT           0x4b67cf4d
</span></span><span class=line><span class=cl> CLASS            demo.MathGame
</span></span><span class=line><span class=cl> METHOD           primeFactors
</span></span><span class=line><span class=cl> IS-RETURN        <span class=nb>false</span>
</span></span><span class=line><span class=cl> IS-EXCEPTION     <span class=nb>true</span>
</span></span><span class=line><span class=cl> PARAMETERS<span class=o>[</span>0<span class=o>]</span>    @Integer<span class=o>[</span>-564322413<span class=o>]</span>
</span></span><span class=line><span class=cl> THROW-EXCEPTION  java.lang.IllegalArgumentException: number is: -564322413, need &gt;<span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>                      at demo.MathGame.primeFactors<span class=o>(</span>MathGame.java:46<span class=o>)</span>
</span></span><span class=line><span class=cl>                      at demo.MathGame.run<span class=o>(</span>MathGame.java:24<span class=o>)</span>
</span></span><span class=line><span class=cl>                      at demo.MathGame.main<span class=o>(</span>MathGame.java:16<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>row-cnt:1<span class=o>)</span> cost in <span class=m>11</span> ms.
</span></span></code></pre></td></tr></table></div></div><h4 id=重做一次调用>重做一次调用</h4><p>当你稍稍做了一些调整之后，你可能需要前端系统重新触发一次你的调用，此时得求爷爷告奶奶的需要前端配合联调的同学再次发起一次调用。而有些场景下，这个调用不是这么好触发的。</p><p><code>tt</code> 命令由于保存了当时调用的所有现场信息，所以我们可以自己主动对一个 <code>INDEX</code> 编号的时间片自主发起一次调用，从而解放你的沟通成本。此时你需要 <code>-p</code> 参数。通过 <code>--replay-times</code> 指定 调用次数，通过 <code>--replay-interval</code> 指定多次调用间隔(单位 ms, 默认 1000ms)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tt -i <span class=m>1004</span> -p
</span></span><span class=line><span class=cl> RE-INDEX       <span class=m>1004</span>
</span></span><span class=line><span class=cl> GMT-REPLAY     2018-12-04 11:26:00
</span></span><span class=line><span class=cl> OBJECT         0x4b67cf4d
</span></span><span class=line><span class=cl> CLASS          demo.MathGame
</span></span><span class=line><span class=cl> METHOD         primeFactors
</span></span><span class=line><span class=cl> PARAMETERS<span class=o>[</span>0<span class=o>]</span>  @Integer<span class=o>[</span>946738738<span class=o>]</span>
</span></span><span class=line><span class=cl> IS-RETURN      <span class=nb>true</span>
</span></span><span class=line><span class=cl> IS-EXCEPTION   <span class=nb>false</span>
</span></span><span class=line><span class=cl> COST<span class=o>(</span>ms<span class=o>)</span>         0.186073
</span></span><span class=line><span class=cl> RETURN-OBJ     @ArrayList<span class=o>[</span>
</span></span><span class=line><span class=cl>                    @Integer<span class=o>[</span>2<span class=o>]</span>,
</span></span><span class=line><span class=cl>                    @Integer<span class=o>[</span>11<span class=o>]</span>,
</span></span><span class=line><span class=cl>                    @Integer<span class=o>[</span>17<span class=o>]</span>,
</span></span><span class=line><span class=cl>                    @Integer<span class=o>[</span>2531387<span class=o>]</span>,
</span></span><span class=line><span class=cl>                <span class=o>]</span>
</span></span><span class=line><span class=cl>Time fragment<span class=o>[</span>1004<span class=o>]</span> successfully replayed.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>row-cnt:1<span class=o>)</span> cost in <span class=m>14</span> ms.
</span></span></code></pre></td></tr></table></div></div><p>你会发现结果虽然一样，但调用的路径发生了变化，由原来的程序发起变成了 Arthas 自己的内部线程发起的调用了。</p><h4 id=观察表达式>观察表达式</h4><p><code>-w, --watch-express</code> 观察时空隧道使用 <code>ognl</code> 表达式</p><ul><li><p>使用表达式核心变量中所有变量作为已知条件编写表达式。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>arthas@10718<span class=o>]</span>$ tt -t demo.MathGame run -n <span class=m>5</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>56</span> ms, listenerId: <span class=m>1</span>
</span></span><span class=line><span class=cl>INDEX      TIMESTAMP                   COST<span class=o>(</span>ms<span class=o>)</span>     IS-RET     IS-EXP      OBJECT              CLASS                                     METHOD
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl><span class=m>1000</span>       2021-01-08 21:54:17         0.901091     <span class=nb>true</span>       <span class=nb>false</span>       0x7699a589          MathGame                                  run
</span></span><span class=line><span class=cl><span class=o>[</span>arthas@10718<span class=o>]</span>$ tt -w <span class=s1>&#39;target.illegalArgumentCount&#39;</span>  -x <span class=m>1</span> -i <span class=m>1000</span>
</span></span><span class=line><span class=cl>@Integer<span class=o>[</span>60<span class=o>]</span>
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>row-cnt:1<span class=o>)</span> cost in <span class=m>7</span> ms.
</span></span></code></pre></td></tr></table></div></div></li><li><p>获取类的静态字段、调用类的静态方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>arthas@10718<span class=o>]</span>$ tt -t demo.MathGame run -n <span class=m>5</span>
</span></span><span class=line><span class=cl>Press Q or Ctrl+C to abort.
</span></span><span class=line><span class=cl>Affect<span class=o>(</span>class count: <span class=m>1</span> , method count: 1<span class=o>)</span> cost in <span class=m>56</span> ms, listenerId: <span class=m>1</span>
</span></span><span class=line><span class=cl>INDEX      TIMESTAMP                   COST<span class=o>(</span>ms<span class=o>)</span>     IS-RET     IS-EXP      OBJECT              CLASS                                     METHOD
</span></span><span class=line><span class=cl>----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl><span class=m>1000</span>       2021-01-08 21:54:17         0.901091     <span class=nb>true</span>       <span class=nb>false</span>       0x7699a589          MathGame                                  run
</span></span><span class=line><span class=cl><span class=o>[</span>arthas@10718<span class=o>]</span>$ tt -w <span class=s1>&#39;@demo.MathGame@random.nextInt(100)&#39;</span>  -x <span class=m>1</span> -i <span class=m>1000</span>
</span></span><span class=line><span class=cl>@Integer<span class=o>[</span>46<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>注意这里使用 <code>com.taobao.arthas.core.advisor.Advice#getLoader</code> 加载,使用精确 <code>classloader</code> ognl 更好。</p></li><li><p>需要强调的点</p><ol><li>ThreadLocal 信息丢失</li></ol><p>很多框架偷偷的将一些环境变量信息塞到了发起调用线程的 ThreadLocal 中，由于调用线程发生了变化，这些 ThreadLocal 线程信息无法通过 Arthas 保存，所以这些信息将会丢失。</p><p>一些常见的 CASE 比如：鹰眼的 TraceId 等。</p><ol start=2><li>引用的对象</li></ol><p>需要强调的是，tt 命令是将当前环境的对象引用保存起来，但仅仅也只能保存一个引用而已。如果方法内部对入参进行了变更，或者返回的对象经过了后续的处理，那么在 tt 查看的时候将无法看到当时最准确的值。这也是为什么 watch 命令存在的意义。</p></li></ul><h4 id=通过索引删除指定的-tt-记录>通过索引删除指定的 tt 记录</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>tt -d <span class=m>1001</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=清除所有的-tt-记录>清除所有的 tt 记录</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>tt --delete-all
</span></span></code></pre></td></tr></table></div></div><h3 id=profiler>profiler</h3><blockquote><p><strong>提示</strong></p><p>使用 async-profiler 生成火焰图</p></blockquote><p><code>profiler</code> 命令支持生成应用热点的火焰图。本质上是通过不断的采样，然后把收集到的采样结果生成火焰图。</p><p><code>profiler</code> 命令基本运行结构是 <code>profiler action [actionArg]</code></p><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>action</em></td><td>要执行的操作</td></tr><tr><td style=text-align:right><em>actionArg</em></td><td>属性名模式</td></tr><tr><td style=text-align:right>[i:]</td><td>采样间隔（单位：ns）（默认值：10'000'000，即 10 ms）</td></tr><tr><td style=text-align:right>[f:]</td><td>将输出转储到指定路径</td></tr><tr><td style=text-align:right>[d:]</td><td>运行评测指定秒</td></tr><tr><td style=text-align:right>[e:]</td><td>要跟踪哪个事件（cpu, alloc, lock, cache-misses 等），默认是 cpu</td></tr></tbody></table></div><h4 id=启动-profiler>启动 profiler</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>profiler start
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>提示</strong></p><p>默认情况下，生成的是 cpu 的火焰图，即 event 为 cpu。可以用&ndash;event 参数来指定。</p></blockquote><h4 id=获取已采集的-sample-的数量>获取已采集的 sample 的数量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ profiler getSamples
</span></span><span class=line><span class=cl><span class=m>23</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=查看-profiler-状态>查看 profiler 状态</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ profiler status
</span></span><span class=line><span class=cl><span class=o>[</span>cpu<span class=o>]</span> profiling is running <span class=k>for</span> <span class=m>4</span> seconds
</span></span></code></pre></td></tr></table></div></div><p>可以查看当前 profiler 在采样哪种 <code>event</code> 和采样时间。</p><h4 id=停止-profiler>停止 profiler</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 默认情况下，结果文件是html格式，也可以用--format参数指定：</span>
</span></span><span class=line><span class=cl>$ profiler stop --format html
</span></span><span class=line><span class=cl>profiler output file: /tmp/test/arthas-output/20211207-111550.html
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl><span class=c1># 或者在--file参数里用文件名指名格式。比如--file /tmp/result.html 。</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=profiler-支持的-events>profiler 支持的 events</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 在不同的平台，不同的 OS 下面，支持的 events 各有不同。可以使用命令查看：</span>
</span></span><span class=line><span class=cl>profiler list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可以用--event参数指定要采样的事件，比如对alloc事件进入采样：</span>
</span></span><span class=line><span class=cl>profiler start --event alloc
</span></span></code></pre></td></tr></table></div></div><h4 id=恢复采样>恢复采样</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>profiler resume
</span></span></code></pre></td></tr></table></div></div><p><code>start</code> 和 <code>resume</code> 的区别是：<code>start</code> 是新开始采样，<code>resume</code> 会保留上次 <code>stop</code> 时的数据。</p><p>通过执行 <code>profiler getSamples</code> 可以查看 <code>samples</code> 的数量来验证。</p><h4 id=使用-execute-来执行复杂的命令>使用 execute 来执行复杂的命令</h4><p>比如开始采样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>profiler execute <span class=s1>&#39;start,framebuf=5000000&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>停止采样，并保存到指定文件里：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>profiler execute <span class=s1>&#39;stop,file=/tmp/result.html&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=查看所有支持的-action>查看所有支持的 action</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ profiler actions
</span></span><span class=line><span class=cl>Supported Actions: <span class=o>[</span>resume, dumpCollapsed, getSamples, start, list, execute, version, stop, load, dumpFlat, actions, dumpTraces, status<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=查看版本>查看版本</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ profiler version
</span></span><span class=line><span class=cl>Async-profiler 1.6 built on Sep  <span class=m>9</span> <span class=m>2019</span>
</span></span><span class=line><span class=cl>Copyright <span class=m>2019</span> Andrei Pangin
</span></span></code></pre></td></tr></table></div></div><h4 id=配置-framebuf-参数>配置 framebuf 参数</h4><blockquote><p>如果遇到生成的火焰图有 [frame_buffer_overflow]，则需要增大 framebuf（默认值是 1'000'000），可以显式配置，比如：</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>profiler start --framebuf <span class=m>5000000</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=配置-includeexclude-来过滤数据>配置 include/exclude 来过滤数据</h4><p>如果应用比较复杂，生成的内容很多，想只关注部分数据，可以通过 include/exclude 来过滤。比如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>profiler start --include <span class=s1>&#39;java/*&#39;</span> --include <span class=s1>&#39;demo/*&#39;</span> --exclude <span class=s1>&#39;*Unsafe.park*&#39;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>include/exclude 都支持设置多个值 ，但是需要配置在命令行的最后。</p></blockquote><h4 id=指定执行时间>指定执行时间</h4><p>比如，希望 profiler 执行 300 秒自动结束，可以用 <code>-d/--duration</code> 参数指定：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>profiler start --duration <span class=m>300</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=生成-jfr-格式结果>生成 jfr 格式结果</h4><p>注意，jfr 只支持在 <code>start</code> 时配置。如果是在 <code>stop</code> 时指定，则不会生效。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>profiler start --file /tmp/test.jfr
</span></span></code></pre></td></tr></table></div></div><p><code>file</code> 参数支持一些变量：</p><ul><li>时间戳： &ndash;file /tmp/test-%t.jfr</li><li>进程 ID： &ndash;file /tmp/test-%p.jfr</li></ul><p>生成的结果可以用支持 jfr 格式的工具来查看。比如：</p><ul><li>JDK Mission Control</li><li>JProfiler</li></ul><h3 id=jfr>jfr</h3><blockquote><p><strong>提示</strong></p><p>Java Flight Recorder (JFR) 是一种用于收集有关正在运行的 Java 应用程序的诊断和分析数据的工具。它集成到 Java 虚拟机 (JVM) 中，几乎不会造成性能开销，因此即使在负载较重的生产环境中也可以使用。</p></blockquote><p><code>jfr</code> 命令支持在程序动态运行过程中开启和关闭 JFR 记录。 记录收集有关 event 的数据。事件在特定时间点发生在 JVM 或 Java 应用程序中。每个事件都有一个名称、一个时间戳和一个可选的有效负载。负载是与事件相关的数据，例如 CPU 使用率、事件前后的 Java 堆大小、锁持有者的线程 ID 等。</p><p><code>jfr</code> 命令基本运行结构是 <code>jfr cmd [actionArg]</code></p><blockquote><p>注意： JDK8 的 8u262 版本之后才支持 jfr</p></blockquote><div class=table-wrapper><table><thead><tr><th style=text-align:right>参数名称</th><th>参数说明</th></tr></thead><tbody><tr><td style=text-align:right><em>cmd</em></td><td>要执行的操作 支持的命令【start，status，dump，stop】</td></tr><tr><td style=text-align:right><em>actionArg</em></td><td>属性名模式</td></tr><tr><td style=text-align:right>[n:]</td><td>记录名称</td></tr><tr><td style=text-align:right>[r:]</td><td>记录 id 值</td></tr><tr><td style=text-align:right>[dumponexit:]</td><td>程序退出时，是否要 dump 出 .jfr 文件，默认为 false</td></tr><tr><td style=text-align:right>[d:]</td><td>延迟多久后启动 JFR 记录，支持带单位配置，eg: 60s, 2m, 5h, 3d. 不带单位就是秒，默认无延迟</td></tr><tr><td style=text-align:right>[duration:]</td><td>JFR 记录持续时间，支持单位配置，不带单位就是秒，默认一直记录</td></tr><tr><td style=text-align:right>[s:]</td><td>采集 Event 的详细配置文件，默认是 default.jfc 位于 $JAVA_HOME/lib/jfr/default.jfc</td></tr><tr><td style=text-align:right>[f:]</td><td>将输出转储到指定路径</td></tr><tr><td style=text-align:right>[maxage:]</td><td>缓冲区数据最大文件记录保存时间，支持单位配置，不带单位就是秒，默认是不限制</td></tr><tr><td style=text-align:right>[maxsize:]</td><td>缓冲区的最大文件大小，支持单位配置， 不带单位是字节，m 或者 M 代表 MB，g 或者 G 代表 GB。</td></tr><tr><td style=text-align:right>[state:]</td><td>jfr 记录状态</td></tr></tbody></table></div><h4 id=启动-jfr-记录>启动 JFR 记录</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ jfr start
</span></span><span class=line><span class=cl>Started recording 1. No limit specified, using <span class=nv>maxsize</span><span class=o>=</span>250MB as default.
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>提示</strong></p><p>默认情况下，开启的是默认参数的 jfr 记录</p></blockquote><p>启动 jfr 记录，指定记录名，记录持续时间，记录文件保存路径。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ jfr start -n myRecording --duration 60s -f /tmp/myRecording.jfr
</span></span><span class=line><span class=cl>Started recording 2. The result will be written to:
</span></span><span class=line><span class=cl>/tmp/myRecording.jfr
</span></span></code></pre></td></tr></table></div></div><h4 id=查看-jfr-记录状态>查看 JFR 记录状态</h4><p>默认是查看所有 JFR 记录信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ jfr status
</span></span><span class=line><span class=cl>Recording: <span class=nv>recording</span><span class=o>=</span><span class=m>1</span> <span class=nv>name</span><span class=o>=</span>Recording-1 <span class=o>(</span>running<span class=o>)</span>
</span></span><span class=line><span class=cl>Recording: <span class=nv>recording</span><span class=o>=</span><span class=m>2</span> <span class=nv>name</span><span class=o>=</span>myRecording <span class=nv>duration</span><span class=o>=</span>PT1M <span class=o>(</span>closed<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>查看指定记录 id 的记录信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ jfr status -r <span class=m>1</span>
</span></span><span class=line><span class=cl>Recording: <span class=nv>recording</span><span class=o>=</span><span class=m>1</span> <span class=nv>name</span><span class=o>=</span>Recording-1 <span class=o>(</span>running<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>查看指定状态的记录信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ jfr status --state closed
</span></span><span class=line><span class=cl>Recording: <span class=nv>recording</span><span class=o>=</span><span class=m>2</span> <span class=nv>name</span><span class=o>=</span>myRecording <span class=nv>duration</span><span class=o>=</span>PT1M <span class=o>(</span>closed<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=dump-jfr-记录>dump jfr 记录</h4><p><code>jfr dump</code> 会输出从开始到运行该命令这段时间内的记录到 JFR 文件，且不会停止 <code>jfr</code> 的记录
指定记录输出路径</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ jfr dump -r <span class=m>1</span> -f /tmp/myRecording1.jfr
</span></span><span class=line><span class=cl>Dump recording 1, The result will be written to:
</span></span><span class=line><span class=cl>/tmp/myRecording1.jfr
</span></span></code></pre></td></tr></table></div></div><p>不指定文件输出路径，默认是保存到 arthas-output 目录下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ jfr dump -r <span class=m>1</span>
</span></span><span class=line><span class=cl>Dump recording 1, The result will be written to:
</span></span><span class=line><span class=cl>/tmp/test/arthas-output/20220819-200915.jfr
</span></span></code></pre></td></tr></table></div></div><h4 id=停止-jfr-记录>停止 jfr 记录</h4><p>不指定记录输出路径，默认是保存到 arthas-output 目录下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ jfr stop -r <span class=m>1</span>
</span></span><span class=line><span class=cl>Stop recording 1, The result will be written to:
</span></span><span class=line><span class=cl>/tmp/test/arthas-output/20220819-202049.jfr
</span></span></code></pre></td></tr></table></div></div><blockquote><p>注意一条记录只能停止一次。</p></blockquote><p>也可以指定记录输出路径。</p><h4 id=通过浏览器查看-arthas-output-下面-jfr-记录的结果>通过浏览器查看 arthas-output 下面 JFR 记录的结果</h4><p>默认情况下，arthas 使用 8563 端口，则可以打开： http://localhost:8563/arthas-output/ 查看到 arthas-output 目录下面的 JFR 记录结果。</p><p>生成的结果可以用支持 jfr 格式的工具来查看。比如：</p><ul><li>JDK Mission Control</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/arthas/>Arthas</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/macos-setup/><div class=article-details><h2 class=article-title>Macos Setup</h2></div></a></article><article><a href=/post/software-list/><div class=article-details><h2 class=article-title>软件列表</h2></div></a></article><article><a href=/post/deployment-configs/><div class=article-details><h2 class=article-title>服务器服务管理</h2></div></a></article><article><a href=/post/docker-depend-and-health/><div class=article-details><h2 class=article-title>Docker Compose 服务依赖和健康检查</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Lucas's Article</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>